<TDocStdTable id="docs_rec_PageContainer" style="width:100%;height:100%;">
    <div id="docs_rec_ListContainer" style="width:310px;height:100%; margin:0;padding:0;"></div>
    <div id="docs_rec_DetailContainer" style="width:100%;height:100%; margin:0;padding:0;">
        <div id="docs_rec_DetailHeader" style="width:100%;height:auto; margin:0;padding:0;"></div>
        <div id="docs_rec_ProductsTable" style="width:100%;height:100%; margin:0;padding:0;"></div>
        <div id="docs_rec_DetailTotal" style="width:100%;height:auto;; margin:0;padding:0;"></div>
    </div>
    <div id="docs_rec_DetailPanesContainer" style="width:250px;height:100%; margin:0;padding:0;"></div>
</TDocStdTable>
<script type="text/javascript">
    $$.docs_rec_PageContainer
            .init({idListContainer:"docs_rec_ListContainer",idDetailContainer:"docs_rec_DetailContainer",
                idDetailHeader:"docs_rec_DetailHeader",idDetailTable:"docs_rec_ProductsTable",idDetailTotal:"docs_rec_DetailTotal",
                idDetailPanesContainer:"docs_rec_DetailPanesContainer" })
            .addListTable({getDataUrl:"/docs/rec/getDataForRecsListTable",
                header:"Список накладных", bdatelabelText:"c",bdateCondition:"DOCDATE>=", edatelabelText:"по",edateCondition:"DOCDATE<="
            })
            .setDetailHeaderParameters({dataIDName:"ChID",
                getDataUrl:"/docs/rec/getRecData", getDataForNewUrl:"/docs/rec/getNewRecData",
                postDataUrl:"/docs/rec/storeRecData", postForDeleteDataUrl:"/docs/rec/deleteRecData",
                docDetailEditable:function(params){ return true; }
            })
            .addDetailHeaderTitle({title:"Приход товара",
                titleForNew:"Новая приходная накладная", titleForNothing:"Приход товара не выбран", titleForFailedLoad:"Нет данных",
                numberDataItemName:"DocID", dateDataItemName:"DocDate", titleDatePrefix:"от"},25)
            .addDetailHeaderRow(25,true)
            .addDetailHeaderSelect("OurName","Фирма", 330,
            {selectStyle:"width:250px", loadDropDownURL:"/dirsDocs/getDirOursForSelect", labelDataItem:"OurName"})
            .addDetailHeaderTextBox("DocID", "Номер", 120, {inputStyle:"width:50px"})
            .addDetailHeaderTextBox("IntDocID", "Вн. номер", 120, {inputStyle:"width:50px"})
            .addDetailHeaderDateTextBox("DocDate", "Дата", 150, "width:80px")
            .addDetailHeaderRow(25,true)
            .addDetailHeaderSelect("StockName","Склад", 330,
            {selectStyle:"width:250px", loadDropDownURL:"/dirsDocs/getDirStocksForSelect", labelDataItem:"StockName"})
            .addDetailHeaderSelect("CompName","Предприятие", 280,
            {selectStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirCompsForSelect", labelDataItem:"CompName"})
            .addDetailHeaderNumberTextBox("KursMC", "Курс валюты", 200, {inputStyle:"width:40px", pattern:"########0.00"})
            .setDetailTableParameters({conditionIDName:"docChID",
                getDataUrl:"/docs/rec/getDataForRecDTable",
                storeDataUrl:"/docs/rec/storeRecDTableData", deleteDataUrl:"/docs/rec/deleteRecDTableData"})
            .addDetailTotalRow()
            .addDetailSubTotalCountNumberTextBox("ИТОГО СТРОК:", 190, {inputStyle:"width:40px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО КОЛИЧЕСТВО:", 700, "Qty", {pattern:"###,###,##0.#########", inputStyle:"width:50px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО СУММА:", 245, "SumCC_wt", {pattern:"###,###,##0.00#######", inputStyle:"width:80px;"})
            .addDetailTotalRow(true)
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ КОЛИЧЕСТВО:", 890, "TQty",
            {pattern:"###,###,##0.#########", inputStyle:"width:50px;", style:"font-weight:bold;", printLabel:"ИТОГО КОЛИЧЕСТВО:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ СУММА:", 245, "TSumCC_wt",
            {pattern:"###,###,##0.00#######", inputStyle:"width:80px;", style:"font-weight:bold;", printLabel:"ИТОГО СУММА:"})
            .addDetailTotalRow(true)
            .addToolPane({title:"Действия"})
            .addToolPaneActionButton("Новая накладная", {btnStyle:"width:200px;", actionButtonName:"loadHeaderNewValues"})
            .addToolPaneActionButton("Сохранить накладную", {btnStyle:"width:200px;", actionButtonName:"storeHeaderValues"})
            .addToolPaneActionButton("Отменить изменения", {btnStyle:"width:200px;", actionButtonName:"loadHeaderLastValues"})
            .addToolPaneActionButton("Удалить накладную", {btnStyle:"width:200px;", actionButtonName:"deleteHeader"})
            .addToolPaneBR()
            .addToolPaneActionButton("Добавить строку", {btnStyle:"width:200px;", actionButtonName:"insertDetailTableRow"})
            .addToolPaneActionButton("Копировать строку", {btnStyle:"width:200px;", actionButtonName:"insertDetailTableCopySelectedRow"})
            .addToolPaneActionButton("Изменить строку", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableSelectedRow"})
            .addToolPaneActionButton("Сохранить строку", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableSelectedRow"})
            .addToolPaneActionButton("Удалить строку", {btnStyle:"width:200px;", actionButtonName:"deleteDetailTableSelectedRow"})
            .addDetailTableMenuItemAction("Добавить строки",{action:"insertDetailTableRowsAfterSelected",rowPosName:"POS"})//rowPosIndexName:"POSIND"
            .addDetailTableMenuItemAction("Изменить строки",{action:"allowEditDetailTableSelectedRows"})
            .addDetailTableMenuItemAction("Сохранить строки",{action:"storeDetailTableSelectedRows"})
            .addDetailTableRowChangeAction(function(crd/*changedRowData*/, detailTable, doc, nextCallback) {
                if(!doc.setDetailTableProdData)
                    doc.setDetailTableProdData= function(crd/*changedRowData*/,prodData){
                        if(!prodData){
                            crd.item("Barcode").setValue(null); crd.item("ProdID").setValue(null);
                            return;
                        }
                        crd.item("ProdID").setValue(prodData["ProdID"]);
                        crd.item("ProdName").setValue(prodData["ProdName"]);
                        crd.item("UM").setValue(prodData["UM"]);
                        crd.item("Barcode").setValue(prodData["Barcode"]);
                    };
                if(!doc.setDetailTableProdArticle1Attrs)
                    doc.setDetailTableProdArticle1Attrs= function(crd/*changedRowData*/,prodArticle1Data,prodArticle1Name){
                        if(!prodArticle1Data)prodArticle1Data={};
                        crd.item("PCatName").setValue(prodArticle1Data["PCatName"]);
                        crd.item("PGrName").setValue(prodArticle1Data["PGrName"]);
                        crd.item("PGrName1").setValue(prodArticle1Data["PGrName1"]);
                        crd.item("PGrName2").setValue(prodArticle1Data["PGrName2"]);
                        crd.item("PGrName3").setValue(prodArticle1Data["PGrName3"]);
                        crd.item("UM").setValue(prodArticle1Data["UM"]);
                        if(prodArticle1Name!=null){
                            crd.item("ProdID").setValue(null); crd.item("Barcode").setValue(null);
                            crd.item("ProdName").setValue(prodArticle1Name);
                        }
                    };
                if(!doc.setDetailTableProdAttrs)
                    doc.setDetailTableProdAttrs= function(crd/*changedRowData*/,prodData){
                        if(!prodData)prodData={};
                        crd.item("Article1").setValue(prodData["Article1"]);
                        this.setDetailTableProdArticle1Attrs(crd,prodData);
                        crd.item("ColorName").setValue(prodData["ColorName"]);
                        crd.item("SizeName").setValue(prodData["SizeName"]);
                    };
                nextCallback();
            })
            .addDetailTableRowChangeAction(function(crd/*changedRowData*/, detailTable, doc, nextCallback) {
                var isChangedProdAttrs=crd.item("Article1").isChanged()
                        ||crd.item("PCatName").isChanged()||crd.item("PGrName").isChanged()
                        ||crd.item("PGrName1").isChanged()||crd.item("PGrName2").isChanged()||crd.item("PGrName3").isChanged()
                        ||crd.item("ColorName").isChanged()||crd.item("SizeName").isChanged();
                if(isChangedProdAttrs){
                    var conditions={};
                    conditions["Article1"]= crd.item("Article1").getValue();
                    conditions["PCatName"]= crd.item("PCatName").getValue();
                    conditions["PGrName"]= crd.item("PGrName").getValue();
                    conditions["PGrName1"]= crd.item("PGrName1").getValue();
                    conditions["PGrName2"]= crd.item("PGrName2").getValue();
                    conditions["PGrName3"]= crd.item("PGrName3").getValue();
                    conditions["ColorName"]= crd.item("ColorName").getValue();
                    conditions["SizeName"]= crd.item("SizeName").getValue();
                    $$.request.getJSONData({url:"/dirsProds/getProdNameAndAttrsByArticle1", conditions:conditions},
                            function(result){
                                if(result.item) doc.setDetailTableProdArticle1Attrs(crd,result.item,(result.itemProdName)?result.itemProdName["ProdName"]:null);
                                else if(result.error) doc.setDetailTableProdArticle1Attrs(crd);
                                if(!result.item&&result.itemProdName) doc.setDetailTableProdData(crd,result.itemProdName);
//                                else doc.setDetailTableProdData(crd);
                                nextCallback(true);
                            });
                    return;
                }
                nextCallback();
            })
            .addDetailTableRowChangeAction(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
                if( (crd.item("ProdID").isChanged()&&!crd.item("ProdID").isEMPTY())
                        || (crd.item("ProdName").isChanged()&&!crd.item("ProdName").isEMPTY()) ){
                    var conditions={};
                    if(crd.item("ProdID").isChanged()&&!crd.item("ProdID").isEMPTY())
                        conditions["ProdID"]= crd.item("ProdID").getValue();
                    if(crd.item("ProdName").isChanged()&&!crd.item("ProdName").isEMPTY())
                        conditions["ProdName"]= encodeURIComponent(crd.item("ProdName").getValue());
                    $$.request.getJSONData({url:"/dirsProds/getProdDataByIDName", conditions:conditions},
                            function(result){
                                if(!result || !result.item){ nextCallback(); return; }
                                thisInstance.setDetailTableProdData(crd,result.item);
                                thisInstance.setDetailTableProdAttrs(crd,result.item);
                                nextCallback(true);
                            });
                    return;
                }
                nextCallback();
            })
            .addDetailTableRowChangeAction(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback){          //console.log("INV detailTableRowChangeCallback1 ",crd.data());
                var prevSrcPosID=detailTable.getPrevRowDataItemValue(crd.data(),"SrcPosID");
                if(prevSrcPosID===undefined||prevSrcPosID===null||isNaN(prevSrcPosID/1)) prevSrcPosID=0;
                if (crd.item("SrcPosID").isUNDEFNULL()) crd.item("SrcPosID").setValue(prevSrcPosID+1);
                else if (crd.item("SrcPosID").getValue()===prevSrcPosID) crd.item("SrcPosID").setValue(prevSrcPosID+1);
//
                if (crd.item("Qty").isUNDEFNULL()) crd.item("Qty").setValue(1);
                if (crd.item("PriceCC_wt").isUNDEFNULL()) crd.item("PriceCC_wt").setValue(0);
                if (crd.item("SumCC_wt").isUNDEFNULL()) crd.item("SumCC_wt").setValue(0);
                if (crd.item("SumCC_wt").isChanged()&&!crd.item("SumCC_wt").isUNDEFNULL()){                     //console.log("detailTableRowChangeCallback SumCC_wt changed",crd,crd.item("Qty").isEMPTYZERO());
                    if (crd.item("Qty").isEMPTY()&&!crd.item("PriceCC_wt").isEMPTYZERO())
                        crd.item("Qty").setValue( crd.item("SumCC_wt").getValue()/crd.item("PriceCC_wt").getValue() );
                    else if (crd.item("Qty").isEMPTYZERO()) crd.item("PriceCC_wt").setValue(0);
                    else crd.item("PriceCC_wt").setValue( crd.item("SumCC_wt").getValue()/crd.item("Qty").getValue() )
                } else if (crd.item("PriceCC_wt").isChanged()||crd.item("Qty").isChanged()){                    //console.log("detailTableRowChangeCallback PRICE QTY changed",crd);
                    if (crd.item("Qty").isUNDEFNULLZERO()||crd.item("PriceCC_wt").isUNDEFNULLZERO()) crd.item("SumCC_wt").setValue(0);
                    else crd.item("SumCC_wt").setValue( crd.item("PriceCC_wt").getValue()*crd.item("Qty").getValue() )
                } else if (!crd.item("PriceCC_wt").isEMPTY()) {
                    if (crd.item("Qty").isEMPTYZERO()) crd.item("PriceCC_wt").setValue(0);
                    else crd.item("PriceCC_wt").setValue( crd.item("SumCC_wt").getValue()/crd.item("Qty").getValue() )
                }
                if(crd.item("Extra").isEMPTYZERO()) crd.item("Extra").setValue(0);
                if (crd.item("PriceCC_wt").isChanged() || crd.item("Extra").isChanged()) {                      //console.log("PINV detailTableRowChangeCallback1 PRICE or FACTOR isChanged");
                    if (!crd.item("PriceCC_wt").isEMPTY() && !crd.item("Extra").isEMPTY()) {
                        crd.item("PriceCC").setValue( crd.item("PriceCC_wt").getValue()*(1+crd.item("Extra").getValue()/100) );
                    } else
                        crd.item("PriceCC").setValue("");
                } else if (crd.item("PriceCC").isChanged()) {                                                   //console.log("PINV detailTableRowChangeCallback1 SALE_PRICE isChanged");
                    if (!crd.item("Qty").isEMPTY() && !crd.item("PriceCC_wt").isEMPTYZERO()) {
                        crd.item("Extra").setValue( (crd.item("PriceCC").getValue()/crd.item("PriceCC_wt").getValue()-1)*100 );
                    } else
                        crd.item("Extra").setValue("");
                }
//                            if (crd.item("SALE_PRICE").isChanged() && !crd.item("SALE_PRICE").isEMPTYZERO()){
//                                var posSelPrice = crd.item("SALE_PRICE").getValue();                                    console.log("PINV detailTableRowChangeCallback1 SALE_PRICE correct 0.49 ",posSelPrice);
//                                posSelPrice = Math.round(posSelPrice+0.49);
//                                crd.item("SALE_PRICE").setValue(posSelPrice);
//                                var price = crd.item("PRICE").getValue();
//                                if (price!==0)
//                                    crd.item("FACTOR").setValue( posSelPrice / posrate / price );
//                            }
                nextCallback();
            })
//                        .addToolPane({title:"экспорт"})
//                        .addToolPaneActionButton("таблица в эксель", {btnStyle: "width:200px;",detailTableActionName:"exportTableContentToExcel"})
            .addToolPane({title:"Печать"})
            .addToolPaneActionButton("Печать ценников", {btnStyle:"width:200px;",detailTableActionName:"printProdTags",
                actionFunction: function(actionFunctionParams){
                    var printWindow= window.open("/print/printProductsTags");//, "", "location=1,status=1,scrollbars=1,width=650,height=600"
//                    printWindow["pageProdTagType"]= "productTag40x25";
                    printWindow["pageProdTagType"]= "productTag58x60";
                    printWindow["prodTagsContentData"]= actionFunctionParams.detailHTable.getContent();
                }
            })
//            .addToolPaneActionButton("Печать цен", {btnStyle:"width:200px;",detailTableActionName:"printProdPricesTags",
//                actionFunction: function(actionFunctionParams){
//                    var printWindow= window.open("/print/printProductsTags");
//                    //window.open("/print?pinvid="+docs_rec_ContentController.getDataIDValue(), "", "location=1,status=1,scrollbars=1,width=650,height=600");
//                    var detailTableContentData=actionFunctionParams.detailTable.getContent();
//                    for(var row=0;row<detailTableContentData.length;row++) detailTableContentData[row]["QTY"]=1;
//                    printWindow["prodTagsContentData"]= detailTableContentData;
//                    printWindow["pageProdTagType"]= "tag40x25price";
//                }
//            })
            .addToolPane({title:"Информация о товаре",
                detailTableAction:function(params){
                    var detailTableSelectedRow= params.detailHTable.getSelectedRow();
                    if(!detailTableSelectedRow){ params.toolPaneContent.set("content",""); return; }
                    var htCols = params.detailHTable.getColumns(), prodInfoHtml = "";
                    for(var c=0;c<htCols.length;c++){
                        var colItem = htCols[c], colData = colItem["data"], colValue = detailTableSelectedRow[colData];
                        if(colData.indexOf('Prod')==0||colData=='UM'||colData.indexOf('Barcode')==0
                                ||colData.indexOf('Article')==0||colData.indexOf('PCat')==0||colData.indexOf('PGr')==0
                                ||colData.indexOf('Color')==0||colData.indexOf('Size')==0)
                            prodInfoHtml = prodInfoHtml + "<tr><td>"+"<b>"+colItem["name"]+":</b> "+((!colValue)?'':colValue)+"</td></tr>";
                    }
                    params.toolPaneContent.set("content","<table style=\"margin:0;padding:0;\">"+prodInfoHtml+"</table>");
                }
            })
            .addToolInnerPage("Ценник товара", function(params){
                var detailTableSelectedRow= params.detailHTable.getSelectedRow();
                if(!detailTableSelectedRow){ params.toolPaneContent.set("content",""); return; }
                var prodTagContentData = {};
                for(var rowItemName in detailTableSelectedRow) prodTagContentData[rowItemName]= detailTableSelectedRow[rowItemName];
                params.toolPaneContent.set("prodTagContentData", prodTagContentData);
                if(!params.toolPaneContent.get("href")&&!params.toolPaneContent.get("content")){
//                    params.toolPaneContent.set("href","/print/productTag40x25");
//                    params.toolPaneContent.set("href","/print/productTag58x30");
                    params.toolPaneContent.set("href","/print/productTag58x60");
                }else{
                    params.toolPaneContent.set("content",params.toolPaneContent.get("content"));
                }
            })
            .startupDoc();
</script>
