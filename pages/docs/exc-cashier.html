<TDocStdTable id="docs_excCashier_PageContainer" style="width:100%;height:100%;">
    <div id="docs_excCashier_ListContainer" style="width:310px;height:100%; margin:0;padding:0;"></div>
    <div id="docs_excCashier_DetailContainer" style="width:100%;height:100%; margin:0;padding:0;">
        <div id="docs_excCashier_DetailHeader" style="width:100%;height:auto; margin:0;padding:0;"></div>
        <div id="docs_excCashier_ProductsTable" style="width:100%;height:100%; margin:0;padding:0;"></div>
        <div id="docs_excCashier_DetailTotal" style="width:100%;height:auto;; margin:0;padding:0;"></div>
    </div>
    <div id="docs_excCashier_RightContainer" style="width:250px;height:100%; margin:0;padding:0;"></div>
</TDocStdTable>
<script type="text/javascript">
    $$.docs_excCashier_PageContainer
            .init({idListContainer:"docs_excCashier_ListContainer",idDetailContainer:"docs_excCashier_DetailContainer",
                idDetailHeader:"docs_excCashier_DetailHeader",idDetailTable:"docs_excCashier_ProductsTable",idDetailTotal:"docs_excCashier_DetailTotal",
                idRightContainer:"docs_excCashier_RightContainer",
                buttonPrint:false, buttonExportToExcel:false})
            .addListTable({getDataUrl:"/docs/excCashier/getDataForExcsListTable",
                header:"Список накладных", bdatelabelText:"c",bdateCondition:"DOCDATE>=", edatelabelText:"по",edateCondition:"DOCDATE<="
            })
            .setDetailHeaderParameters({dataIDName:"ChID",getDataUrl:"/docs/excCashier/getExcData",
                detailHeaderEditable:false,
                detailTableEditable:function(params){
                    if(!params||!params.detailHeaderContentData) return false;
                    var stateCode=params.detailHeaderContentData["StateCode"];
                    return stateCode==50||stateCode==56||stateCode==60;
                }
            })
            .addDetailHeaderTitle({title:"Перемещение товара на ТТ",titleForNothing:"Перемещение товара не выбрано", titleForFailedLoad:"Нет данных",
                numberDataItemName:"DocID", dateDataItemName:"DocDate", titleDatePrefix:"от"},25)
            .addDetailHeaderRow(25,true)
            .addDetailHeaderSelect("OurName","Фирма", 330,{inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirOursForSelect", labelDataItem:"OurName"})
            .addDetailHeaderTextBox("DocID", "Номер", 120, {inputStyle:"width:50px"})
            .addDetailHeaderTextBox("IntDocID", "Вн. номер", 120, {inputStyle:"width:50px"})
            .addDetailHeaderDateTextBox("DocDate", "Дата", 150, "width:80px")
            .addDetailHeaderRow(25,true)
            .addDetailHeaderSelect("StockName","Со склада", 250,
                {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirStocksForSelect", labelDataItem:"StockName"})
            .addDetailHeaderSelect("NewStockName","На склад", 280,
                {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirStocksForSelect", labelDataItem:"NewStockName"})
            .addDetailHeaderSelect("CurrName","Валюта", 260,
                {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirCurrsForSelect", labelDataItem:"CurrName"})
            .setDetailTableParameters({conditionIDName:"ParentChID",
                getDataUrl:"/docs/excCashier/getDataForExcDTable",
                storeDataUrl:"/docs/excCashier/storeExcDTableData", deleteDataUrl:"/docs/excCashier/deleteExcDTableData"})
            .addDetailTotalRow()
            .addDetailSubTotalCountNumberTextBox("ИТОГО СТРОК:", 140, {inputStyle:"width:40px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО КОЛ-ВО:", 410, "Qty", {pattern:"###,###,##0.#########", inputStyle:"width:50px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО ФАКТ. КОЛ-ВО:", 240, "NewQty", {pattern:"###,###,##0.#########", inputStyle:"width:50px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО СУММА:", 220, "SumCC", {pattern:"###,###,##0.00#######", inputStyle:"width:80px;"})
            .addDetailTotalRow(true)
            .addDetailTotalTextBox("Статус:", 300, "StateName", {style:"font-weight:bold;", inputStyle:"width:200px", print:false})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ КОЛ-ВО:", 250, "TQty",
                {pattern:"###,###,##0.#########", inputStyle:"width:50px;", style:"font-weight:bold;", printLabel:"ИТОГО КОЛИЧЕСТВО:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ ФАКТ. КОЛ-ВО:", 240, "TNewQty",
                {pattern:"###,###,##0.#########", inputStyle:"width:50px;", style:"font-weight:bold;", printLabel:"ИТОГО КОЛИЧЕСТВО:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ СУММА:", 220, "TSumCC",
                {pattern:"###,###,##0.00#######", inputStyle:"width:80px;", style:"font-weight:bold;", printLabel:"ИТОГО СУММА:"})
            .addToolPane({title:"Действия"})
            .addToolPaneActionButton("Изменить строку", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableSelectedRow"})
            .addToolPaneActionButton("Изменить все строки", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableAllVisibleRows"})
            .addToolPaneBR()
            .addToolPaneActionButton("Заполнить факт", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var dhtContentEditableRows= ap.detailHTable.getContentEditableRows();
                    ap.detailHTable.updateRowsAction(dhtContentEditableRows,{},
                            /*actionFunction*/function(rowData, actionParams, updatedRowData, nextAction, finishedAction){
                                updatedRowData["NewQty"]= rowData["Qty"];
                                nextAction();
                            }
                    );
                },
                actionStateFunction:function(ap){
                    if(ap.detailHeader.getContentData() && !ap.detailHeader.isContentChanged() && ap.detailHTable.getContentEditableRows().length>0)
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPaneBR()
            .addToolPaneActionButton("Сохранить строку", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableSelectedRow"})
            .addToolPaneActionButton("Сохранить все строки", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableAllEditableRows"})
            .addDetailTableMenuItemAction("Изменить строки",{action:"allowEditDetailTableSelectedRows"})
            .addDetailTableMenuItemAction("Сохранить строки",{action:"storeDetailTableSelectedRows"})
            .addToolPane({title:"Статус"})
            .addToolPaneActionButton("В статус \"Подтвержден\"", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(!detailHeaderContentData){ this.setDisabled(true); return; }
                    var docStateData= {"StateCode":detailHeaderContentData["StateCode"],"StateName":detailHeaderContentData["StateName"]},
                            stateCodeConfirm= detailHeaderContentData["StateCodeConfirm"],
                            detailHeaderContentChangedData= {"StateCode":stateCodeConfirm};
                    $$.request.getJSONData({url:"/dirsDocs/getDirStateData", resultItemName:"item",
                                conditions:{"StateCode":detailHeaderContentChangedData["StateCode"]+""},
                                errorDialogMsg:"Не удалось получить данные для перевода документа в статус "+stateCodeConfirm+"!"},
                            function(result,error){
                                if(!result||error)return;
                                var newStateName= result["StateName"];
                                detailHeaderContentChangedData["StateName"]= newStateName;
                                ap.detailHeader.setContentDataItems(detailHeaderContentChangedData,{onlyValues:true,callContentUpdated:true});
                                $$.request.postJSONData({url:"/docs/excCashier/updExcDataState", resultItemName:"resultItem",
                                            data:{"ChID":detailHeaderContentData["ChID"],"StateCode":detailHeaderContentChangedData["StateCode"]},
                                            errorDialogMsg:"Не удалось перевести документ в статус \""+newStateName+"\" ("+stateCodeConfirm+")!"},
                                        function(result,error){
                                            if(!result||error){
                                                ap.detailHeader.setContentDataItems(docStateData,{onlyValues:false,callContentUpdated:true});
                                                return;
                                            }
                                            ap.detailHeader.setContentDataItems({"StateCode":result["StateCode"],"StateName":result["StateName"]},
                                                    {onlyValues:false,callContentUpdated:true,updatedResultItem:detailHeaderContentChangedData});
                                        });
                            });
                },
                actionStateFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(detailHeaderContentData && !ap.detailHeader.isContentChanged()
                            && ap.thisDoc.detailTableEditableChecker() && ap.detailHTable.getContent().length>0)
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPaneActionButton("В статус \"Возвращен\"", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(!detailHeaderContentData){ this.setDisabled(true); return; }
                    var docStateData= {"StateCode":detailHeaderContentData["StateCode"],"StateName":detailHeaderContentData["StateName"]},
                            stateCodeRetrieve= detailHeaderContentData["StateCodeRetrieve"],
                            detailHeaderContentChangedData= {"StateCode":stateCodeRetrieve};
                    $$.request.getJSONData({url:"/dirsDocs/getDirStateData", resultItemName:"item",
                                conditions:{"StateCode":detailHeaderContentChangedData["StateCode"]+""},
                                errorDialogMsg:"Не удалось получить данные для перевода документа в статус "+stateCodeRetrieve+"!"},
                            function(result,error){
                                if(!result||error)return;
                                var newStateName= result["StateName"];
                                detailHeaderContentChangedData["StateName"]= newStateName;
                                ap.detailHeader.setContentDataItems(detailHeaderContentChangedData,{onlyValues:true,callContentUpdated:true});
                                $$.request.postJSONData({url:"/docs/excCashier/updExcDataState", resultItemName:"resultItem",
                                            data:{"ChID":detailHeaderContentData["ChID"],"StateCode":detailHeaderContentChangedData["StateCode"]},
                                            errorDialogMsg:"Не удалось перевести документ в статус \""+newStateName+"\" ("+stateCodeRetrieve+")!"},
                                        function(result,error){
                                            if(!result||error){
                                                ap.detailHeader.setContentDataItems(docStateData,{onlyValues:false,callContentUpdated:true});
                                                return;
                                            }
                                            ap.detailHeader.setContentDataItems({"StateCode":result["StateCode"],"StateName":result["StateName"]},
                                                    {onlyValues:false,callContentUpdated:true,updatedResultItem:detailHeaderContentChangedData});
                                        });
                            });
                },
                actionStateFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(detailHeaderContentData && !ap.detailHeader.isContentChanged()
                            && ap.thisDoc.detailTableEditableChecker())
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPane({title:"Информация о товаре",
                detailTableAction:function(toolPane, detailHeader,detailTable,thisInstance){
                    var detailTableSelectedRow= detailTable.getSelectedRow();
                    if(!detailTableSelectedRow){ toolPane.set("content",""); return; }
                    var htCols = detailTable.getColumns(), prodInfoHtml = "";
                    for(var c=0;c<htCols.length;c++){
                        var colItem = htCols[c]; var colData = colItem["data"], colValue = detailTableSelectedRow[colData];
                        if(colData.indexOf('Prod')==0||colData=='UM'||colData.indexOf('Barcode')==0
                                ||colData.indexOf('Article')==0||colData.indexOf('PCat')==0||colData.indexOf('PGr')==0
                                ||colData.indexOf('Color')==0||colData.indexOf('Size')==0)
                            prodInfoHtml = prodInfoHtml + "<tr><td>"+"<b>"+colItem["name"]+":</b> "+((!colValue)?'':colValue)+"</td></tr>";
                    }
                    toolPane.set("content","<table style=\"margin:0;padding:0;\">"+prodInfoHtml+"</table>");
                }
            })
            .addToolXPane("Ценник товара", function(toolPane, detailHeader,detailTable,thisInstance){
                var detailTableSelectedRow= detailTable.getSelectedRow();
                if(!detailTableSelectedRow){ toolPane.set("content",""); return; }
                var prodTagContentData= {};
                for(var rowItemName in detailTableSelectedRow) prodTagContentData[rowItemName]= detailTableSelectedRow[rowItemName];
                toolPane.set("prodTagContentData", prodTagContentData);
                toolPane.set("href","/print/productTag40x25");
            })
            .startupDoc();
</script>
