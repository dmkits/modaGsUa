<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" id="pageReportsCashier">
    <div class="navbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link icon-only panel-open" data-panel="left">
                    <i class="icon f7-icons">menu</i>
                </a>
            </div>
            <div class="title sliding">Отчеты кассира</div>
        </div>
    </div>
    <div class="subnavbar docHeaderTitle" id="pageVenDataToolbar" style="width:100%;border-top-style:solid;border-top-width:1px">
        <div class="subnavbar-inner">
            <div class="row" style="padding-left:16px;padding-right:16px;width:100%;display:table">
                <a href="#" id="pageReportsCashier-cr" class="col item-link smart-select" style="display:table-cell;min-width:180px;" @smartselect:closed="pageReportsCashierCRClosed">
                    <div class="item-content">
                        <div class="item-inner" style="min-height:30px">
                            <div class="item-title" style="display:contents">Касса</div>
                            <div id="pageReportsCashier-cr-label" class="item-after" style="display:contents;margin-left:0px;max-width:80%;color:#212121"></div>
                        </div>
                    </div>
                    <select id="pageReportsCashier-cr-select">`
                        {{#each listCRs}}
                        <option value={{value}}>{{label}}</option>
                        {{/each}}
                    </select>
                </a>
                <a class="col" style="display:table-cell;width:140px">
                    <div class="item-content">
                        <div class="item-inner item-input">
                            <div class="item-title1 item-label1" style="margin:0px;font-size:14px">Дата или период</div>
                            <div class="item-input-wrap" style="margin-top:1px;color:#212121">
                                <input type="text" placeholder="Период дат" readonly id="pageReportsCashierDatesRange" style="font-size:12px;" @calendar:closed="pageReportsCashierDatesRangeClosed"/>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
    <div class="page-content" style="padding-top:88px">
        <table width="100%" class="mobile-table-small-size tableReport tableReportCashierSales" style="position:fixed;left:0px;top:88px; z-index:100;" >
            <thead>
            <tr>
                <th rowspan="2" width="65px" class="datetime-cell">Дата<br>время<br>чека</th>
                <th colspan="5">Товар</th>
            </tr>
            <tr>
                <th></th>
                <th width="45px">Кол-во</th>
                <th width="50px">Цена</th>
                <th width="60px">Сумма</th>
                <th width="50px">Скидка,<br>%</th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true">
                <td width="65px" rowspan="2" class="datetime-cell" dataItemName="SDocTime"><div class="table-text-mi"></div></td>
                <td colspan="5" class="tdProdName" dataItemName="ProdName"><div class="table-text"></div></td>
            </tr>
            <tr rowSelecting="true">
                <td></td>
                <td width="45px" class="text-centered" dataItemName="Qty"><div class="table-text"></div></td>
                <td width="50px" class="numeric-cell" dataItemName="RealPrice"><div class="table-text"></div></td>
                <td width="60px" class="numeric-cell" dataItemName="RealSum"><div class="table-text"></div></td>
                <td width="50px" class="text-centered" dataItemName="DiscountP"><div class="table-text"></div></td>
            </tr>
            </tbody>
        </table>
        <table width="100%" class="mobile-table-small-size tableReport tableReportCashierSales" style="margin-top:55px;margin-bottom:30px;"></table>
        <table width="100%" class="mobile-table-small-size tableReport tableReportCashierSales" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="65px" class="datetime-cell">0</td>
                <td></td>
                <td id="totalQty" width="45px">0</td>
                <td width="50px"></td>
                <td id="totalRealSum" width="60px">0</td>
                <td width="50px"></td>
            </tr>
            </tfoot>
        </table>
        <table width="100%" class="mobile-table-large-size tableReport tableReportCashierSales" style="position:fixed;left:0px;top:88px; z-index:100;" >
            <thead>
            <tr>
                <th width="65px" class="datetime-cell">Дата<br>время<br>чека</th>
                <th width="80px">Номер<br>чека</th>
                <th width="50px">Код товара</th>
                <th>Наименование товара</th>
                <th width="45px">Кол-во</th>
                <th width="55px">Цена</th>
                <th width="70px">Сумма</th>
                <th width="50px">Скидка,<br>%</th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true">
                <td width="65px" class="datetime-cell" dataItemName="SDocTime"><div class="table-text-mi"></div></td>
                <td width="80px" class="text-centered" dataItemName="DocID"><div class="table-text"></div></td>
                <td width="50px" class="text-centered" dataItemName="ProdID"><div class="table-text"></div></td>
                <td class="tdProdName" dataItemName="ProdName"><div class="table-text"></div></td>
                <td width="45px" class="text-centered" dataItemName="Qty"><div class="table-text"></div></td>
                <td width="55px" class="numeric-cell" dataItemName="RealPrice"><div class="table-text"></div></td>
                <td width="70px" class="numeric-cell" dataItemName="RealSum"><div class="table-text"></div></td>
                <td width="50px" class="text-centered" dataItemName="DiscountP"><div class="table-text"></div></td>
            </tr>
            </tbody>
        </table>
        <table width="100%" class="mobile-table-large-size tableReport tableReportCashierSales" style="margin-top:55px;margin-bottom:30px;"></table>
        <table width="100%" class="mobile-table-large-size tableReport tableReportCashierSales" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="65px" class="datetime-cell">0</td>
                <td></td>
                <td id="totalQty" width="45px">0</td>
                <td width="55px"></td>
                <td id="totalRealSum" width="70px">0</td>
                <td width="50px"></td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        on: {
            pageInit: function(e,page){
                var dataTables=$$(this.el).children(".page-content").children("table");
                if(dataTables&&dataTables[0]) this.contentTableHeaderDomEl= dataTables[0];
                if(dataTables&&dataTables[1]) this.contentTableDataDomEl= dataTables[1];
                if(dataTables&&dataTables[2]) this.contentTableFootDomEl= dataTables[2];
                if(dataTables&&dataTables[3]) this.contentTableLHeaderDomEl= dataTables[3];
                if(dataTables&&dataTables[4]) this.contentTableLDataDomEl= dataTables[4];
                if(dataTables&&dataTables[5]) this.contentTableLFootDomEl= dataTables[5];
                if(this.crIDFilter===undefined) this.crIDFilter="";
                var calendarRange= app7.calendar.create({ inputEl:'#pageReportsCashierDatesRange',
                    dateFormat:'dd.mm.yyyy', rangePicker:true, value:[new Date()] });
                var self=this;
                this.loadStocksForCashierData(function(listCRs){
                    if(!listCRs||listCRs.length==0) return;
                    var listCRsItem=listCRs[0];
                    $$('#pageReportsCashier-cr-select').val(listCRsItem.value); self.crIDFilter= listCRsItem.value;
                    $$('#pageReportsCashier-cr').find("#pageReportsCashier-cr-label").text(listCRsItem.label);
                    self.loadSalesForCashierData();
                });
            }
        },
        methods:{
            loadStocksForCashierData:function(callback){
                let cInstance=this;
                app7.srvRequestJSON({url:'/reports/products/getDirCRsForSelect',
                            errorDialogMsg:"Не удалось получить список касс для кассира с сервера!"},
                        function(result,error){                                                             //console.log('pageReportsCashier.html loadStocksForCashierData result=',result);
                            app7.preloader.hide();
                            if(!result){ if(callback)callback(); return; }
                            app7.data.pageReportsCashier= {listCRs:result.items,crIDFilter:cInstance.crIDFilter,items:null};
                            cInstance.$setState({listCRs:result.items,crIDFilter:cInstance.crIDFilter,items:null});
                            if(callback)callback(result.items);
                        })
            },
            loadSalesForCashierData:function(){
                let cInstance=this,
                        crIDFilter=this.crIDFilter;
                app7.preloader.show();
                var conditions={}, sdates=$$("#pageReportsCashierDatesRange").val();
                if(sdates){
                    var dates=sdates.split("-");
                    if(dates.length==1){
                        conditions["@BDate"]= moment(dates[0],"DD.MM.YYYY").format("YYYY-MM-DD"); conditions["@EDate"]=conditions["@BDate"];
                    }else
                        for(var i=0;i<dates.length;i++){
                            var val=dates[i];
                            if(i==0) conditions["@BDate"]= moment(val,"DD.MM.YYYY").format("YYYY-MM-DD");
                            else if(i==dates.length-1) conditions["@EDate"]= moment(val,"DD.MM.YYYY").format("YYYY-MM-DD");
                        }
                }
                if(crIDFilter=='') conditions['CRID is NULL']="null"; else conditions['CRID=']= crIDFilter;
                app7.srvRequestJSON({url:'/mobile/reports/getSalesCRRetsForCashier',conditions:conditions,
                            errorDialogMsg:"Не удалось получить продажи с сервера!"},
                        function(result,error){
                            app7.preloader.hide();
                            if(!result)return;
                            app7.data.pageReportsCashier= {listCRs:cInstance.listCRs,crIDFilter:crIDFilter,items:result.items};
                            cInstance.$setState({listCRs:cInstance.listCRs,crIDFilter:crIDFilter,items:result.items});
                            cInstance.fillCashierReportTable(result.items);
                        })
            },
            fillCashierReportTable: function(reportData,finishedCallback){
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],{totalRows:0,totalQty:0,totalRealSum:0});
                this.contentTableFoot={};
                var self=this,
                        params={ contentTableHeaderDomEl:this.contentTableHeaderDomEl, contentTableDataDomEl:this.contentTableDataDomEl,
                                contentTable2HeaderDomEl:this.contentTableLHeaderDomEl, contentTable2DataDomEl:this.contentTableLDataDomEl,
                            progressAction:function(tableData, ind,tableDataItem){
                                if(!tableDataItem){ self.setTotalInfo(0,0); return; }
                                self.setTotalInfo(tableDataItem["Qty"],tableDataItem["RealSum"],ind+1);
                            }
                        };
                app7.innerPageFillTableData(this,reportData,params,finishedCallback)
            },
            setTotalInfo: function(qty,realSum,tLoadedRows){
                var sTotalRows= this.items.length.toString();
                if(tLoadedRows!==undefined) sTotalRows= tLoadedRows.toString()+"/<br>"+sTotalRows;
                this.contentTableFoot["totalQty"]= this.contentTableFoot["totalQty"]||0; this.contentTableFoot["totalQty"]+= qty;
                this.contentTableFoot["totalRealSum"]= this.contentTableFoot["totalRealSum"]||0; this.contentTableFoot["totalRealSum"]+= realSum;
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],
                        {totalRows:sTotalRows,totalQty:this.contentTableFoot["totalQty"],totalRealSum:this.contentTableFoot["totalRealSum"]});
            },
            pageReportsCashierCRClosed:function(e){
                this.crIDFilter= $$('#pageReportsCashier-cr-select').val();
                app7.data.pageReportsCashier.crIDFilter=this.crIDFilter;
                this.loadSalesForCashierData();
            },
            pageReportsCashierDatesRangeClosed:function(e){
                this.loadSalesForCashierData();
            }
        }
    }
</script>
