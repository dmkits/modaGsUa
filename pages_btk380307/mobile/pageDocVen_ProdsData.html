<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" id="pageDocVenProdsData" data-name="pageDocVenProdsData">
    <div class="navbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link back">
                    <i class="icon icon-back"></i><i class="icon icon-back"></i>
                    <!--<span class="ios-only">Назад</span>-->
                </a>
            </div>
            <div class="title docHeaderTitle">
                <span>Инвентаризация {{item.DocID}} от {{item.SDocDate}}</span><br>
                <span style="font-size:14px;font-weight:normal">{{item.StockName}}</span>
            </div>
            <div class="subnavbar docHeaderTitle" id="pageDocVenProdsData-Toolbar" style="width:100%;border-top-style:solid;border-top-width:1px">
                <div class="subnavbar-inner">
                    <div class="row" style="padding-left:16px;padding-right:16px;">
                        <input type="number" class="col" style="height:36px;min-width:200px;" id="pageDocVenProdsData-BarCodeInput" placeholder="ШК или код товара">
                        <button class="col button button-outline button-round" id="pageDocVenProdsData-BtnBarcodeInputEnter" style="width:80px;margin-top:3px">ВВОД</button>
                        <div>
                            <span id="pageDocVenProdsData-StateInfo" style="color:black;font-weight:bold;display:none"></span><br>
                            <span id="pageDocVenProdsData-StateName" style="color:black;font-weight:bold;font-size:12px;display:none"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content" id="pageContentDocVenProdsData">
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th width="40px">№<br>п/п</th>
                <th>Наименование товара<br>Код товара</th>
                <!--<th width="50px">Ед.<br>изм.</th>-->
                <th width="50px">Уч.<br>кол-во</th>
                <th width="50px">Факт.<br>кол-во</th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true">
                <td rowSpan="2" width="40px" class="tdSrcPosID" dataItemName="TSrcPosID"></td>
                <td colSpan="4" class="tdProdName" dataItemName="ProdName"></td>
            </tr>
            <tr rowSelecting="true">
                <td class="text-centered" dataItemName="ProdID"></td>
                <!--<td width="50px" class="text-centered" dataItemName="UM"></td>-->
                <td width="50px" class="tdQty" dataItemName="TQty"></td>
                <td width="50px" class="tdNewQty" dataItemName="TNewQty"
                    onCreated="inventoryTableTDNewQtyOnCreated" onClick="venDataTableTDNewQtyOnClick"></td>
            </tr>
            </tbody>
        </table>
        <table class="mobile-table-small-size" width="100%" style="margin-top:33px;margin-bottom:30px;"></table>
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px">0</td>
                <td></td>
                <td id="totalQty" width="50px">0</td>
                <td id="totalNewQty" width="50px">0</td>
            </tr>
            </tfoot>
        </table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th width="40px">№<br>п/п</th>
                <th width="110px">Штрихкод</th>
                <th width="50px">Код товара</th>
                <th>Наименование товара</th>
                <th width="50px">Ед.<br>изм.</th>
                <th width="50px">Уч.<br>кол-во</th>
                <th width="50px">Факт.<br>кол-во</th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true">
                <td width="40px" class="tdSrcPosID" dataItemName="TSrcPosID"></td>
                <td width="110px" style="min-width:110px" class="text-centered" dataItemName="Barcode"></td>
                <td width="50px" class="text-centered" dataItemName="ProdID"></td>
                <td class="tdProdName" dataItemName="ProdName"></td>
                <td width="50px" class="text-centered" dataItemName="UM"></td>
                <td width="50px" class="tdQty" dataItemName="TQty"></td>
                <td width="50px" class="tdNewQty" dataItemName="TNewQty"
                    onCreated="inventoryTableTDNewQtyOnCreated" onClick="venDataTableTDNewQtyOnClick"></td>
            </tr>
            </tbody>
        </table>
        <table class="mobile-table-large-size" width="100%" style="margin-top:33px;margin-bottom:30px;"></table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px">0</td>
                <td></td>
                <td id="totalQty" width="50px">0</td>
                <td id="totalNewQty" width="50px">0</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        on: {
            pageInit: function(e,page){                                            console.log("i",this.item,this.items);
                this.pageContentDocVenProdsData= $$(this.el).children("#pageContentDocVenProdsData");
                if(!this.pageContentDocVenProdsData){ this.setInputProdBarcodeByState(); return; }
                var contentTables= this.pageContentDocVenProdsData.children("table");
                if(contentTables&&contentTables[0]) this.contentTableHeaderDomEl= contentTables[0];
                if(contentTables&&contentTables[1]) this.contentTableDataDomEl= contentTables[1];
                if(contentTables&&contentTables[2]) this.contentTableFootDomEl= contentTables[2];
                if(contentTables&&contentTables[3]) this.contentTableLHeaderDomEl= contentTables[3];
                if(contentTables&&contentTables[4]) this.contentTableLDataDomEl= contentTables[4];
                if(contentTables&&contentTables[5]) this.contentTableLFootDomEl= contentTables[5];
                if(!this.item){ this.setInputProdBarcodeByState(); return; }
                if(this.item["StateCode"]!==0){ this.loadVenProdsData(); return; }
                var self=this;
                $$('#pageDocVenProdsData-Toolbar #pageDocVenProdsData-BtnBarcodeInputEnter').on('click',function(){
                    self.barcodeInputEnter();
                });
                $$('#pageDocVenProdsData-Toolbar #pageDocVenProdsData-BarCodeInput').on('keypress',function(e){
                    if(e.keyCode==13||e.key=='Enter')self.barcodeInputEnter();
                });
//                if(deviceBarcodeScannerReaderAction){
//                    deviceBarcodeScannerReaderAction= function(barcode){
//                        var pageDom=$$('.view-main #pageDocVenProdsData');
//                        if(pageDom.length==0||!pageDom[0]||pageDom[0].innerHTML.length==0) return;              //alert("pageDocVenProdsData scan:"+barcode);
//                        if(barcode) barcode= barcode.replace("\n","");
//                        self.barcodeInputEnter(barcode);
//                    }
//                }
                this.loadVenProdsData();
            },
            pageAfterOut: function(e,page){
                if(this.progressBarEl) this.$app.progressbar.hide(this.progressBarEl);
            },
        },
        data: function(){                                            console.log("d");
            var venData={}, listVensData= app7.data.pageDocVenDocsList.listDocs;
            if(!this.$route.params) return {};
            var venChID= this.$route.params.venChID;
            if(!listVensData||venChID===null||venChID===undefined) return {};
            for(var ind in listVensData){
                var itemInventData= listVensData[ind];
                if(itemInventData&&itemInventData["ChID"]==venChID){ venData= itemInventData; break; }
            }                                                                                                   console.log("d-e");
            return {item:venData};
        },
        methods: {
            loadVenProdsData: function(){                                                                             //console.log('pageDocVen_ProdsData.html loadVenProdsData venData=',this.item);
                this.setInputProdBarcodeByState({focus:true,enable:false});
                var venData=this.item, venChID=venData.ChID;
                if(venChID===null||venChID===undefined) return;
                var self=this;                                                                                  //console.log('pageDocVen_ProdsData.html loadVenProdsData venChID=',venChID, this);
                app7.preloader.show();
                app7.srvRequestJSON({url:'/mobile/docVen/getDataForVenATable',conditions:{'ParentChID=':venChID},
                            errorDialogMsg:"Не удалось получить список товаров инвентаризации с сервера!"},
                        function(result,error){
                            app7.preloader.hide();
                            var resultItems=(result)?result.items:null;
                            self.items=resultItems;
                            if(!resultItems){ self.setInputProdBarcodeByState(); return; }
                            app7.data.pageDocVen= {docProdsItems:resultItems};                                    //console.log('pageDocVenProdsData loadVenProdsData resultItems=',resultItems);
                            if(error||!resultItems) return;
                            var params={ contentTableHeaderDomEl:self.contentTableHeaderDomEl,contentTableDataDomEl:self.contentTableDataDomEl,
                                contentTable2HeaderDomEl:self.contentTableLHeaderDomEl,contentTable2DataDomEl:self.contentTableLDataDomEl,
                                progressAction:function(tableData, ind,tableDataItem){
                                    if(!tableDataItem){ self.setTotalInfo(0,0); return; }
                                    self.setTotalInfo(tableDataItem["TQty"],tableDataItem["TNewQty"],ind+1);
                                }
                            };
                            app7.innerPageFillTableData(self, resultItems, params, function(){
                                self.setInputProdBarcodeByState({focus:true,enable:true});
                            })
                        })
            },
            setTotalInfo: function(tQty,tNewQty,tLoadedRows){
                var tRows= (this.items)?this.items.length.toString():0;
                if(tLoadedRows!==undefined) tRows= tLoadedRows.toString()+"/<br>"+tRows;
                var contentTableFootTR= $$(this.contentTableFootDomEl).find("tr"),
                        totalQty= parseFloat(contentTableFootTR.find("td#totalQty").text())+tQty,
                        totalNewQty= parseFloat(contentTableFootTR.find("td#totalNewQty").text())+tNewQty;
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],
                        {totalRows:tRows,totalQty:totalQty,totalNewQty:totalNewQty});
            },
            /**
             * opts = { enable, disable, focus, val }
             */
            setInputProdBarcodeByState: function(opts){                                  console.log("setInputProdBarcodeByState",this.item,this.items);
                var pageDocVenDataBarCodeInput=$$("#pageDocVenProdsData-Toolbar #pageDocVenProdsData-BarCodeInput"),
                        pageDocVenDataBtnBarcodeInputEnter=$$('#pageDocVenProdsData-Toolbar #pageDocVenProdsData-BtnBarcodeInputEnter'),
                        pageDocVenDataStateInfo=$$('#pageDocVenProdsData-Toolbar #pageDocVenProdsData-StateInfo'),
                        pageDocVenDataStateName=$$('#pageDocVenProdsData-Toolbar #pageDocVenProdsData-StateName');
                if(!this.item||(this.item&&this.item["StateCode"]!==0)||!this.items){
                    pageDocVenDataBarCodeInput.attr('disabled',1);
                    pageDocVenDataBtnBarcodeInputEnter.attr('disabled',1);
                    pageDocVenDataBarCodeInput.hide();pageDocVenDataBtnBarcodeInputEnter.hide();
                    pageDocVenDataStateInfo.show();pageDocVenDataStateInfo.text(this.item["StateInfo"]);
                    pageDocVenDataStateName.show();pageDocVenDataStateName.text(this.item["StateName"]);
                    return;
                }
                if(!opts)return;
                pageDocVenDataBarCodeInput.show();pageDocVenDataBtnBarcodeInputEnter.show();
                pageDocVenDataStateInfo.hide();pageDocVenDataStateName.hide();
                if(opts.val!==undefined)pageDocVenDataBarCodeInput.val(opts.val);
                if(opts.enable==true||opts.disable==false){
                    pageDocVenDataBarCodeInput.removeAttr('disabled');
                    pageDocVenDataBtnBarcodeInputEnter.removeAttr('disabled');
                    if(opts.focus==true) pageDocVenDataBarCodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                }else if(opts.disable==true||opts.enable==false){
                    if(opts.focus==true) pageDocVenDataBarCodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                    pageDocVenDataBarCodeInput.attr('disabled',1);
                    pageDocVenDataBtnBarcodeInputEnter.attr('disabled',1);
                }else if(opts.focus==true){
                    pageDocVenDataBarCodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                }
            },

            inventoryTableTDNewQtyOnCreated: function(td,tableDataItem,methods){
                td.id="id_"+tableDataItem["ChID"].toString()+'_'+tableDataItem["TSrcPosID"].toString();
                td.ChID=tableDataItem["ChID"].toString();td.TSrcPosID=tableDataItem["TSrcPosID"].toString();
                td.ProdID=tableDataItem["ProdID"].toString();td.ProdName=tableDataItem["ProdName"].toString();
                td.TQty=tableDataItem["TQty"].toString();
                td.doSelect=methods["rowSelectingMethod"];
                tableDataItem.tableTDNewQty= td;
            },
            addProdToTable: function(prodData){
                if(!prodData) prodData={TQty:0,TNewQty:0};
                var existstdReal=$$(this.contentTableDataDomEl).children("tr").children("#id_"+prodData["ChID"]+"_"+prodData["TSrcPosID"])[0];
                if(existstdReal){
                    var oldTNewQty=parseFloat(existstdReal.innerText), tNewQty=prodData["TNewQty"],
                        oldTQty=parseFloat(existstdReal.TQty), tQty=prodData["TQty"];
                    existstdReal.innerText=tNewQty; existstdReal.TQty=tQty;
                    existstdReal.doSelect();
                    this.setScroll(existstdReal);
                    this.setTotalInfo(tQty-oldTQty,tNewQty-oldTNewQty);
                    return;
                }
                app7.innerPageCreateTableRow(this.contentTableHeaderDomEl,this.contentTableDataDomEl, prodData, this);
                prodData.tableTDNewQty.doSelect();
                this.setTotalInfo(prodData["TQty"],prodData["TNewQty"]);
                this.setScroll(prodData.tableTDNewQty);
            },



            barcodeInputEnter: function(scanBarcode){
                this.setInputProdBarcodeByState({disable:true});
                app7.preloader.show();
                var self=this;
                this.storeInputValueToInvent(scanBarcode || $$("#pageDocVenProdsData-Toolbar #pageDocVenProdsData-BarCodeInput").val(),function(venProdData){
                    app7.preloader.hide();
                    if(venProdData) self.addProdToTable(venProdData);
                    self.setInputProdBarcodeByState({enable:true,focus:(!scanBarcode),val:""});
                });
            },

            venDataTableTDNewQtyOnClick: function(e,dataTableItemName,self){
                if(this.item&&this.item["StateCode"]!==0)return;
                var td=e.target;
                self.showRealQtyDialog(td, dataTableItemName["ProdName"], td.innerText.trim());
            },
            showRealQtyDialog: function(tdReal, prodName, displayedQty){
                var thisInstance=this,
                    realQtyDialog=app7.dialog.create({ title:"Фактический остаток", destroyOnClose:true, text:prodName,
                        content:'<span id="storeRealQtyErrMsg" style="color:red;font-weight:bold;font-size:14px;line-height:1;"></span>'+
                            '<br><input id="inputRealQty" type="number" style="text-align:center;border:solid 1px grey;padding:5px"></<input>',
                        on:{
                            open:function(){
                                $$("#storeRealQtyErrMsg").html("");
                                $$("#inputRealQty").val(displayedQty).focus();document.getElementById("inputRealQty").select();
                                document.getElementById("inputRealQty").onkeydown=function(e){
                                    if(e.key=="Escape"||e.code=="Escape"||e.keyCode==27)realQtyDialog.params.buttons[1].onClick();
                                    else if(e.key=="Enter"||e.code=="Enter"||e.keyCode==13)realQtyDialog.params.buttons[0].onClick();
                                };
                            },
                        },
                        buttons:[
                            { text:"ВВОД",close:false,keyCodes:[13],onClick:function(){
                                var val=parseFloat($$("#inputRealQty").val());
                                if(isNaN(val)){
                                    $$("#storeRealQtyErrMsg").html("Неверное значение количества!");
                                    $$("#inputRealQty").focus();document.getElementById("inputRealQty").select();
                                    return;
                                }
                                thisInstance.storeExistsToInvent(tdReal.TSrcPosID,tdReal.ProdID,val,
                                    function(storeResult,errMsg){
                                        if(errMsg){
                                            $$("#storeRealQtyErrMsg").html(errMsg);
                                            $$("#inputRealQty").focus();document.getElementById("inputRealQty").select();
                                            return;
                                        }
                                        tdReal.innerText=val;
                                        thisInstance.setTotalInfo(0,val-parseFloat(displayedQty));
                                        realQtyDialog.close();
                                    })
                            } },
                            { text:"ОТМЕНА",close:true,keyCodes:[27] } ]
                    }).open().on("closed",function(){ thisInstance.setInputProdBarcodeByState({focus:true}); });
            },

            /**
             * callback = function(prodData,err)
             */
            storeInputValueToInvent: function(inputValue,callback){
                if(!inputValue||inputValue.toString().trim()==''){
                    var self=this;
                    if(!this.dialogAlertNoBarcode)
                        this.dialogAlertNoBarcode=
                            app7.dialog.alert("Не удалось считать штрихкод или код товара!","Внимание",function(){
                                self.dialogAlertNoBarcode=null;
                                callback(null);
                            });
                    else
                        this.dialogAlertNoBarcode.open();
                    return;
                }
                var cInstance=this, parentChID=this.item.ChID;                                                  //console.log('pageDocVen_ProdsData.html storeInputValueToInvent inputValue=',inputValue, this);
                app7.preloader.show();
                app7.srvPostRequestJSON({url:'/mobile/docVen/storeProdDataByCRUniInput',data:{value:inputValue,parentChID:parentChID},
                        userErrorMsg:"Не удалось добавить товар в инвентаризацию!"},
                    function(result,errmsg){
                        app7.preloader.hide();// Hide Preloader
                        if(!result||!result.resultItem){
                            callback(null); return;
                        }
                        var inventProdData=result.resultItem;
                        callback(inventProdData);
                    })
            },
            storeExistsToInvent: function(tSrcPosID,prodID,tNewQty,callback){
                var cInstance=this, parentChID=this.item.ChID;                                                  //console.log('pageDocVen_ProdsData.html storeExistsToInvent tSrcPosID=',tSrcPosID, tNewQty);
                app7.preloader.show();
                app7.srvPostRequestJSON({url:'/mobile/docVen/storeExistsPosProdData',
                        data:{parentChID:parentChID,TSrcPosID:tSrcPosID,TNewQty:tNewQty},
                        userErrorMsg:"Не удалось сохранить данные на сервере!",showRequestErrorDialog:false},
                    function(result,errmsg){
                        app7.preloader.hide();// Hide Preloader
                        if(!result||!result.resultItem){
                            callback(null,(errmsg||"Не удалось сохранить данные на сервере!")); return;
                        }
                        var inventProdData=result.resultItem;
                        callback(inventProdData);
                    })
            },

            setScroll: function(innerElem){
                var page=this.pageContentDocVenProdsData[0],
                        absoluteElementTop = innerElem.getBoundingClientRect().top + page.scrollTop;
                page.scrollTop= absoluteElementTop - (page.clientHeight / 2);//page.scrollTo(1, absoluteElementTop - (page.clientHeight / 2));-fail in mobileApp
            }
        }
    }
</script>
