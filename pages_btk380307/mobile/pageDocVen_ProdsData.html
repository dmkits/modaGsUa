<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" id="pageDocVenProdsData" data-name="pageDocVenProdsData">
    <div class="navbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link back">
                    <i class="icon icon-back"></i><i class="icon icon-back"></i>
                    <!--<span class="ios-only">Назад</span>-->
                </a>
            </div>
            <div class="title docHeaderTitle">
                <span>Инвентаризация {{docData.DocID}} от {{docData.SDocDate}}</span><br>
                <span style="font-size:14px;font-weight:normal">{{docData.StockName}}</span>
            </div>
            <div class="subnavbar docHeaderTitle" id="pageDocVenProdsDataToolbar" style="width:100%;border-top-style:solid;border-top-width:1px;border-bottom-width:1px">
                <div class="subnavbar-inner">
                    <div class="row" style="padding-left:16px;padding-right:16px;">
                        <input type="number" class="col" style="height:36px;min-width:200px;" id="pageDocVenProdsDataBarCodeInput" placeholder="ШК или код товара">
                        <button class="col button button-outline button-round" id="pageDocVenProdsDataBtnBarcodeInputEnter" style="width:80px;margin-top:3px">ВВОД</button>
                        <div>
                            <span id="pageDocVenProdsDataStateInfo" style="color:black;font-weight:bold;display:none"></span><br>
                            <span id="pageDocVenProdsDataStateName" style="color:black;font-weight:bold;font-size:12px;display:none"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content" id="pageContentDocVenProdsData">
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th width="40px">№<br>п/п</th>
                <th>Наименование товара<br>Код товара</th>
                <!--<th width="50px">Ед.<br>изм.</th>-->
                <th width="50px">Уч.<br>кол-во</th>
                <th width="50px">Факт.<br>кол-во</th>
            </tr>
            </thead>
        </table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th width="40px">№<br>п/п</th>
                <th width="110px">Штрихкод</th>
                <th width="50px">Код товара</th>
                <th>Наименование товара</th>
                <th width="50px">Ед.<br>изм.</th>
                <th width="50px">Уч.<br>кол-во</th>
                <th width="50px">Факт.<br>кол-во</th>
            </tr>
            </thead>
        </table>
        <div class="list virtual-list media-list virtual-list-table" style="width:100%;margin-top:33px;margin-bottom:30px;font-size:inherit;vertical-align:middle">
            <ul class="virtual-list-ul-table" style="width:100%">
                <li class="virtual-list-li-table" style="width:100%;display:none">
                    <table class="mobile-table-small-size" width="100%" dataItemIDName="TSrcPosID">
                        <tr class="mobile-vtable-row-small-size">
                            <td class="mobile-vtable-cell-small-size" width="40px" rowspan="2"><div class="table-text tdSrcPosID" dataItemName="TSrcPosID"></div></td>
                            <td class="mobile-vtable-cell-small-size" colspan="3"><div class="table-text tdProdName" dataItemName="ProdName"></div></td>
                        </tr>
                        <tr class="mobile-vtable-row-small-size">
                            <td class="mobile-vtable-cell-small-size" style=""><div class="table-text" dataItemName="ProdID"></div></td>
                            <!--<td class="mobile-vtable-cell-small-size" width="50px"><div class="table-text"  dataItemName="UM"></div></td>-->
                            <td class="mobile-vtable-cell-small-size" width="50px"><div class="table-text tdQty" dataItemName="TQty"></div></td>
                            <td class="mobile-vtable-cell-small-size" width="50px"><div class="table-text tdNewQty" dataItemIDName="TSrcPosID" dataItemName="TNewQty"></div></td>
                        </tr>
                    </table>
                    <table class="mobile-table-large-size" width="100%" dataItemIDName="TSrcPosID">
                        <tr class="mobile-vtable-row-large-size">
                            <td class="mobile-vtable-cell-large-size" width="40px"><div style="" class="table-text tdSrcPosID" dataItemName="TSrcPosID"></div></td>
                            <td class="mobile-vtable-cell-large-size" width="110px" style="min-width:110px"><div class="table-text text-centered" dataItemName="Barcode"></div></td>
                            <td class="mobile-vtable-cell-large-size" width="50px"><div class="table-text text-centered" dataItemName="ProdID"></div></td>
                            <td class="mobile-vtable-cell-large-size"><div class="table-text tdProdName" dataItemName="ProdName"></div></td>
                            <td class="mobile-vtable-cell-large-size" width="50px"><div class="table-text text-centered" dataItemName="UM"></div></td>
                            <td class="mobile-vtable-cell-large-size" width="50px"><div class="table-text tdQty" dataItemName="TQty"></div></td>
                            <td class="mobile-vtable-cell-large-size" width="50px"><div class="table-text tdNewQty" dataItemIDName="TSrcPosID" dataItemName="TNewQty"></div></td>
                        </tr>
                    </table>
                </li>
            </ul>
        </div>
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px" style="max-width:50px">0</td>
                <td></td>
                <td id="totalQty" width="50px" style="max-width:50px">0</td>
                <td id="totalNewQty" width="50px" style="max-width:50px">0</td>
            </tr>
            </tfoot>
        </table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px" style="max-width:40px">0</td>
                <td></td>
                <td id="totalQty" width="50px" style="max-width:50px">0</td>
                <td id="totalNewQty" width="50px" style="max-width:50px">0</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        on: {
            pageInit: function(e,page){
                this.pageContentDocVenProdsData= $$(this.el).children("#pageContentDocVenProdsData");
                if(!this.pageContentDocVenProdsData){ this.setInputProdBarcodeByState(); return; }
                this.contentTableVirtList= app7.virtualList.create({
                    el: this.$el.find('.virtual-list-table'),// List Element
                    createUl: true,
                    ul: this.$el.find('.virtual-list-ul-table'),
                    cache: true,
                    items: [],//Pass array with items
                    itemTemplate:app7.getVListTemplate(this.$el.find('.virtual-list-li-table')[0]),//it.outerHTML,// List item Template7 template
                    height: 35// Item height, 35 for item heght=33px with border
                });
                var contentTables= this.pageContentDocVenProdsData.children("table");
                if(contentTables&&contentTables[1]) this.contentTableFootDomEl= contentTables[2];
                if(contentTables&&contentTables[3]) this.contentTableLFootDomEl= contentTables[3];
                this.pageDocVenProdsDataBarCodeInput= $$('#pageDocVenProdsDataToolbar #pageDocVenProdsDataBarCodeInput');
                this.pageDocVenProdsDataBtnBarcodeInputEnter= $$('#pageDocVenProdsDataToolbar #pageDocVenProdsDataBtnBarcodeInputEnter');
                this.pageDocVenProdsDataStateInfo= $$('#pageDocVenProdsDataToolbar #pageDocVenProdsDataStateInfo');
                this.pageDocVenProdsDataStateName= $$('#pageDocVenProdsDataToolbar #pageDocVenProdsDataStateName');
                if(this.isDocReadOnly()){ this.loadVenProdsData(); return; }
                var self=this;
                this.pageDocVenProdsDataBarCodeInput.on('keypress',function(e){
                    if(e.keyCode==13||e.key=='Enter')self.barcodeInputEnter();
                    e.stopPropagation();
                });
                this.pageDocVenProdsDataBtnBarcodeInputEnter.on('click',function(){ self.barcodeInputEnter(); });
                this.contentTableVirtList.$el.find('ul').on('click',function(e){
                    var el= e.target;
                    if(!el||!(el.tagName=="DIV"||el.tagName=="TD")) return;
                    var path= e.path;
                    if(!path) return;
                    for(var pEl of path){
                        if(pEl.tagName!="TABLE")continue;
                        var pELparent= pEl.parentNode;
                        if(!pELparent||pELparent.tagName!="LI"||pELparent.className.indexOf("virtual-list-li-table")<0)continue;
                        self.selContentVTableDataRow(pEl.getAttribute("dataItemIDVal"));
                        break;
                    }
                    var dataItemName= el.getAttribute("dataItemName");
                    if(!dataItemName||dataItemName!="TNewQty") return;
                    var dataItemIDVal= el.getAttribute("dataItemIDVal");
                    self.contentTableTDNewQtyOnClick(e,el,self.contentTableDataItems[dataItemIDVal],self);
                });
                this.loadVenProdsData();
            },
            pageAfterIn: function(e,page){
                var self=this, thisEl=this.el;
                app7.setDocumentKeyActions(app7,
                        {thisEl:thisEl, isNoAction:self.isDocReadOnly, dialog:self.dialogEditQty,
                            inputEl:self.pageDocVenProdsDataBarCodeInput,
                            keyEnterAction:self.barcodeInputEnter,
                            barcodeScannerAction:function(barcode,EndAction){
                                var docData=self.docData, docChID= (docData)?docData["ChID"]:null;
                                self.findProdByBarcode(barcode,docChID,function(prodData){
                                    if(!prodData){
                                        EndAction();
                                        self.setInputProdBarcodeByState({enable:true,focus:false,val:""});
                                        return;
                                    }
                                    var srcPosID= prodData["TSrcPosID"];
                                    if(srcPosID!=null) self.selContentVTableDataRow(srcPosID,{setScroll:true});
                                    var qty= prodData["TQty"], newQty= prodData["TNewQty"];
                                    if(qty==null) qty=0; if(newQty==null) newQty=0;
                                    self.showDialogEditQty({"ProdName":prodData["ProdName"],"TQty":qty,"TNewQty":newQty},
                                            /*okAction*/function(inputValQty,actionSuccess,actionError){
                                                self.storeBarcodeWithQtyToVen(prodData["Barcode"],inputValQty,function(venProdData,errMsg){
                                                    if(errMsg){ actionError(errMsg); return; }
                                                    self.updContentVTableData(venProdData);
                                                    actionSuccess();
                                                });
                                            },/*closedAction*/function(){
                                                EndAction();
                                                self.setInputProdBarcodeByState({enable:true,focus:false,val:""});
                                            });
                                });
                            }
                        });
            },
            pageAfterOut: function(e,page){
                if(this.progressBarEl) this.$app.progressbar.hide(this.progressBarEl);
            },
        },
        data: function(){
            if(!this.$route.params) return {};
            var listVensData= app7.data.pageDocVenDocsList.listDocs, venChID= this.$route.params.venChID;
            if(!listVensData||venChID===null||venChID===undefined) return {};
            var venData={};
            for(var ind in listVensData){
                var itemInventData= listVensData[ind];
                if(itemInventData&&itemInventData["ChID"]==venChID){ venData= itemInventData; break; }
            }
            return {docData:venData};
        },
        methods: {
            isDocReadOnly: function(){
                return !this.docData||!this.docData["IsStateCreated"];
            },
            loadVenProdsData: function(){
                this.contentTableDataItems={}; this.contentTableDataIndexByTSrcPosID={};
                this.contentTableTotalData={};
                this.setInputProdBarcodeByState({focus:false,enable:false});
                var venData=this.docData, venChID=venData.ChID;
                if(venChID===null||venChID===undefined) return;
                var self=this;
                app7.preloader.show();
                app7.srvRequestJSON({url:'/mobile/docVen/getDataForVenATable',conditions:{'docChID=':venChID},
                            errorDialogMsg:"Не удалось получить список товаров инвентаризации с сервера!"},
                        function(result,error){
                            app7.preloader.hide();
                            var resultItems=(result)?result.items:null;
                            self.contentTableData= resultItems; app7.data.pageDocVenProdsData= {contentTableData:resultItems};
                            self.contentTableDataItems=
                                    (!resultItems)?{}:resultItems.reduce(function(result,arrItem,index,array){
                                        result[arrItem["TSrcPosID"]]= arrItem; return result;
                                    },{});
                            self.contentTableDataIndexByTSrcPosID=
                                    (!resultItems)?{}:resultItems.reduce(function(result,arrItem,index,array){
                                        result[arrItem["TSrcPosID"]]= index; return result;
                                    },{});
                            if(!resultItems){ self.setInputProdBarcodeByState(); return; }
                            self.updContentVTableDataItems(resultItems);
                        })
            },
            updContentVTableDataItems: function(contentDataItems){
                this.contentTableVirtList.items= contentDataItems; this.contentTableVirtList.update();
                var tTQty= 0, tTNewQty=0;
                if(contentDataItems)
                    for(var i=0;i<contentDataItems.length;i++){
                        var contentDataItem= contentDataItems[i];
                        tTQty+= contentDataItem["TQty"];  tTNewQty+= contentDataItem["TNewQty"];
                    }
                this.setTotalInfo(tTQty,tTNewQty);
                this.setInputProdBarcodeByState({focus:false,enable:true});
            },
            setTotalInfo: function(qty,newQty,tLoadedRows){
                var sTotalRows= (this.contentTableData)?this.contentTableData.length.toString():0;
                if(tLoadedRows!==undefined) sTotalRows= tLoadedRows.toString()+"/<br>"+sTotalRows;
                this.contentTableTotalData["totalQty"]= this.contentTableTotalData["totalQty"]||0; this.contentTableTotalData["totalQty"]+= qty;
                this.contentTableTotalData["totalNewQty"]= this.contentTableTotalData["totalNewQty"]||0; this.contentTableTotalData["totalNewQty"]+= newQty;
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],
                        {totalRows:sTotalRows,totalQty:this.contentTableTotalData["totalQty"],totalNewQty:this.contentTableTotalData["totalNewQty"]});
            },
            /**
             * opts = { enable, disable, focus, val }
             */
            setInputProdBarcodeByState: function(opts){
                var barcodeInput= this.pageDocVenProdsDataBarCodeInput, btnBarcodeInputEnter= this.pageDocVenProdsDataBtnBarcodeInputEnter,
                        stateInfo= this.pageDocVenProdsDataStateInfo, stateName= this.pageDocVenProdsDataStateName;
                if(this.isDocReadOnly()){
                    barcodeInput.attr('disabled',1); btnBarcodeInputEnter.attr('disabled',1);
                    barcodeInput.hide(); btnBarcodeInputEnter.hide();
                    stateInfo.show(); stateInfo.text(this.docData["StateInfo"]);
                    stateName.show(); stateName.text("("+this.docData["StateName"]+")");
                    return
                }
                if(!opts)return;
                barcodeInput.show(); btnBarcodeInputEnter.show();
                stateInfo.hide(); stateName.hide();
                if(opts.val!==undefined) barcodeInput.val(opts.val);
                if(opts.enable==true||opts.disable==false){
                    barcodeInput.removeAttr('disabled'); btnBarcodeInputEnter.removeAttr('disabled');
                    if(opts.focus==true) barcodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                }else if(opts.disable==true||opts.enable==false){
                    if(opts.focus==true) barcodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                    barcodeInput.attr('disabled',1); btnBarcodeInputEnter.attr('disabled',1);
                }else if(opts.focus==true){
                    barcodeInput.focus();//!IT'S NECESSARILY CALL FOR LARGE DATATABLEBODY DID'NT SLOW DOWN!
                }
            },
            barcodeInputEnter: function(scanBarcode){
                this.setInputProdBarcodeByState({disable:true});
                app7.preloader.show();
                var self=this;
                this.storeProdInputValueToVen(scanBarcode || this.pageDocVenProdsDataBarCodeInput.val(),function(venProdData){
                    app7.preloader.hide();
                    if(venProdData) self.updContentVTableData(venProdData);
                    self.setInputProdBarcodeByState({enable:true,focus:false/*(!scanBarcode)*/,val:""});
                });
            },
            /**
             * callback = function(prodData,err)
             */
            storeProdInputValueToVen: function(inputValue,callback){
                if(!inputValue||inputValue.toString().trim()==''){
                    var self=this;
                    if(!this.dialogAlertNoBarcode)
                        this.dialogAlertNoBarcode=
                                app7.dialog.alert("Не удалось считать штрихкод или код товара!","Внимание",
                                        function(){ self.dialogAlertNoBarcode=null; callback(null); });
                    else
                        this.dialogAlertNoBarcode.open();
                    return;
                }
                app7.preloader.show();
                app7.srvPostRequestJSON({url:'/mobile/docVen/storeProdDataByCRUniInput',data:{value:inputValue,docChID:this.docData["ChID"]},
                            userErrorMsg:"Не удалось добавить товар в инвентаризацию!"},
                        function(result,errmsg){
                            app7.preloader.hide();
                            if(!result||!result.resultItem){ callback(null); return; }
                            callback(result.resultItem);
                        })
            },
            updContentVTableData: function(prodData){
                if(!prodData) prodData={};
                var srcPosID= prodData["TSrcPosID"], ctDataItem= this.contentTableDataItems[srcPosID], cvtIndex=null;
                if(!ctDataItem){//not exists - add new
                    if(!this.contentTableData){ this.contentTableData=[]; this.contentTableVirtList.items=this.contentTableData; }
                    this.contentTableVirtList.appendItem(prodData);
                    if(!this.contentTableDataItems) this.contentTableDataItems={};
                    this.contentTableDataItems[srcPosID]=prodData;
                    cvtIndex= this.contentTableVirtList.items.length-1;
                    this.contentTableDataIndexByTSrcPosID[srcPosID]= cvtIndex;
                    this.setTotalInfo(prodData["TQty"],prodData["TNewQty"]);
                }else{//exists - update exists
                    var oldQty= ctDataItem["TQty"], qty= prodData["TQty"], oldNewQty= ctDataItem["TNewQty"], newQty= prodData["TNewQty"];
                    ctDataItem["TQty"]= qty; ctDataItem["TNewQty"]= newQty;
                    cvtIndex= this.contentTableDataIndexByTSrcPosID[srcPosID];
                    if(cvtIndex!=null) this.contentTableVirtList.replaceItem(cvtIndex,ctDataItem);
                    this.setTotalInfo(qty-oldQty,newQty-oldNewQty);
                }
                if(cvtIndex==null)return;
                this.selContentVTableDataRow(srcPosID,{cvtIndex:cvtIndex,setScroll:true});
            },
            /**
             * params = { cvtIndex, setScroll:true/false }
             */
            selContentVTableDataRow: function(srcPosID,params){
                if(params&&params.setScroll){
                    var cvtIndex= (params&&params.cvtIndex!=null)?params.cvtIndex:this.contentTableDataIndexByTSrcPosID[srcPosID];
                    if(cvtIndex!=null) this.contentTableVirtList.scrollToItem(cvtIndex);                                            console.log("cvtIndex",cvtIndex);
                }
                var cvtIndexELdom= this.contentTableVirtList.$el.find('table[dataitemidval="'+srcPosID+'"]');
                if(!cvtIndexELdom)return;
                this.contentTableVirtListSelItems= this.contentTableVirtListSelItems||[];
                for(var i=0; i<this.contentTableVirtListSelItems.length;i++) this.contentTableVirtListSelItems[i].classList.remove('mobile-table-selectedRow');
                this.contentTableVirtListSelItems= [];
                for(var i=0; i<cvtIndexELdom.length;i++){
                    var cvtIndexEL= cvtIndexELdom[i];                                            console.log("cvtIndexEL",cvtIndexEL,cvtIndexEL.clientHeight);//console.dir(cvtIndexEL);
                    cvtIndexEL.classList.add('mobile-table-selectedRow');
                    this.contentTableVirtListSelItems.push(cvtIndexEL);
                    if(params&&params.setScroll&&cvtIndexEL.clientHeight) this.setScroll(cvtIndexEL);
                }
            },
            contentTableTDNewQtyOnClick: function(e,ownerTD,contentTableDataItem,self){
                if(this.isDocReadOnly())return;
                var tNewQtyEl=e.target;
                this.showDialogEditQty(contentTableDataItem,/*ok/Enter*/function(inputValQty,actionSuccess,actionError){
                    self.storeNewQtyToVenProdData(contentTableDataItem["TSrcPosID"],contentTableDataItem["ProdID"],inputValQty,
                            function(storeResult,errMsg){
                                if(errMsg){ if(actionError) actionError(errMsg); return; }
                                self.updContentVTableData(storeResult);
                                if(actionSuccess) actionSuccess();
                            })
                });
            },
            /**
             * params = { ProdName, Qty }
             * okAction = function(inputValQty,actionSuccess,actionError)
             *      actionSuccess = function(), actionError = function(errMsg)
             * closedAction = function(dialog)
             * actionSuccess - close dialog
             * actionError - don't close dialog, show error message in dialog and focus to input
             */
            showDialogEditQty: function(params, okAction,closedAction){
                var self=this, tdReal= null, newQty= params["TNewQty"];
                this.dialogEditQty= app7.dialog.create({ title:"Фактический остаток", destroyOnClose:true, text:params["ProdName"],
                    content:'<span id="dialogEditQtyErrMsg" style="color:red;font-weight:bold;font-size:14px;line-height:1;"></span>'+
                    '<br><input id="inputNewQty" type="number" style="text-align:center;border:solid 1px grey;padding:5px"></<input>',
                    on:{
                        open:function(){
                            $$("#dialogEditQtyErrMsg").html("");
                            $$("#inputNewQty").val(newQty).focus(); document.getElementById("inputNewQty").select();
                            document.getElementById("inputNewQty").onkeypress= function(e){ e.stopPropagation(); };
                            document.getElementById("inputNewQty").onkeydown=function(e){
                                if(e.key=="Escape"||e.code=="Escape"||e.keyCode==27) self.dialogEditQty.params.buttons[1].onClick();
                                else if(e.key=="Enter"||e.code=="Enter"||e.keyCode==13) self.dialogEditQty.params.buttons[0].onClick();
                                e.stopPropagation();
                            };
                        },
                        closed:function(){
                            if(closedAction) closedAction(self.dialogEditQty);
                            self.setInputProdBarcodeByState({focus:false});
                        }
                    },
                    buttons:[
                        { text:"ВВОД",close:false,keyCodes:[13],onClick:function(){
                            var inputValQty= parseFloat($$("#inputNewQty").val());
                            if(isNaN(inputValQty)){
                                $$("#dialogEditQtyErrMsg").html("Неверное значение количества!");
                                $$("#inputNewQty").focus();document.getElementById("inputNewQty").select();
                                return;
                            }
                            if(!okAction) { self.dialogEditQty.close(); return; }
                            okAction(inputValQty,/*success*/function(){ self.dialogEditQty.close(); },/*error*/function(errMsg){
                                $$("#dialogEditQtyErrMsg").html(errMsg);
                                $$("#inputNewQty").focus(); document.getElementById("inputNewQty").select();
                            });
                        } },
                        { text:"ОТМЕНА",close:true,keyCodes:[27] } ]
                }).open();
            },
            /**
             * callback = function(storeExcDResultItem,errMsg)
             * if no result or no result.resultItem call callback(null,"<error message>")
             * if has result and result.resultItem call callback(storeExcDResultItem=result.resultItem)
             */
            storeNewQtyToVenProdData: function(tSrcPosID,prodID,tNewQty,callback){
                var docChID=this.docData["ChID"];
                app7.preloader.show();
                app7.srvPostRequestJSON({url:'/mobile/docVen/storeExistsPosProdData',data:{docChID:docChID,TSrcPosID:tSrcPosID,TNewQty:tNewQty},
                            userErrorMsg:"Не удалось сохранить данные на сервере!",showRequestErrorDialog:false},
                        function(result,errmsg){
                            app7.preloader.hide();// Hide Preloader
                            if(!result||!result.resultItem){ callback(null,(errmsg||"Не удалось сохранить данные на сервере!")); return; }
                            callback(result.resultItem);
                        })
            },
            /**
             * callback = function(prodData)
             * if no result or no result.item call callback(null)
             * if has result and result.item call callback(prodData=result.itItem)
             */
            findProdByBarcode: function(barcode,docChID,callback){
                if(!barcode||barcode.toString().trim()=='')return;
                app7.preloader.show();
                app7.srvRequestJSON({url:'/mobile/docVen/findProdDataByBarcode',conditions:{"docChID=":docChID,"Barcode=":barcode},
                            userErrorMsg:"Не удалось найти товар по штрихкоду!"},
                        function(result,errmsg){
                            app7.preloader.hide();
                            if(!result||!result.item){ callback(null); return; }
                            callback(result.item);
                        });
            },
            /**
             * callback = function(storeExcDResultItem,errMsg)
             * if no result or no result.resultItem call callback(null,"<error message>")
             * if has result and result.resultItem call callback(storeExcDResultItem=result.resultItem)
             */
            storeBarcodeWithQtyToVen: function(barcode,qty,callback){
                if(!barcode||barcode.toString().trim()==''){
                    var self=this;
                    if(!this.dialogAlertNoBarcode)
                        this.dialogAlertNoBarcode=
                                app7.dialog.alert("Не удалось считать штрихкод или код товара!","Внимание",
                                        function(){ self.dialogAlertNoBarcode=null; callback(null); });
                    else
                        this.dialogAlertNoBarcode.open();
                    return;
                }
                var docChID= (this.docData)?this.docData["ChID"]:null;
                app7.preloader.show();
                app7.srvPostRequestJSON({url:'/mobile/docVen/storeProdBarcodeWithNewQty',data:{docChID:docChID,Barcode:barcode,TNewQty:qty},
                            showRequestErrorDialog:false },
                        function(result,errmsg){
                            app7.preloader.hide();
                            if(!result||!result.resultItem){
                                callback(null,"Не удалось добавить товар по штрихкоду в инвентаризацию!"+((errmsg)?"<br>"+errmsg:""));
                                return;
                            }
                            var excProdData=result.resultItem;
                            callback(excProdData);
                        });
            },
            setScroll: function(innerElem){
                var page=this.pageContentDocVenProdsData[0],
                        absoluteElementTop = innerElem.getBoundingClientRect().top + page.scrollTop;
                page.scrollTop= absoluteElementTop - (page.clientHeight / 2);//page.scrollTo(1, absoluteElementTop - (page.clientHeight / 2));-fail in mobileApp
            }
        }
    }
</script>
