<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" data-name="pageDocRecProdsData">
    <div class="navbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link back">
                    <i class="icon icon-back"></i><i class="icon icon-back"></i>
                    <!--<span class="ios-only">Назад</span>-->
                </a>
            </div>
            <div class="title docHeaderTitle">
                <span class="title docHeaderTitle">Приход товара {{docData.DocID}} от {{docData.SDocDate}}</span><br>
                <span style="font-size:14px;font-weight:normal">{{docData.StockName}}</span>
            </div>
            <div class="subnavbar docHeaderTitle" id="pageDocRecProdsDataToolbar" style="width:100%;border-top-style:solid;border-top-width:1px">
                <div class="subnavbar-inner">
                    <div class="row" style="padding-left:16px;padding-right:16px;width:100%">
                        <button class="col button button-outline button-round" id="pageDocRecProdsDataBtnNewPos">+</button>
                        <button class="col button button-outline button-round" id="pageDocRecProdsDataBtnEdtSel">#</button>
                        <button class="col button button-outline button-round" id="pageDocRecProdsDataBtnDelSel">-</button>
                        <div>
                            <span id="pageDocRecProdsDataState" style="color:black;font-weight:bold;display:none"></span>
                            <span id="pageDocRecProdsDataStateInfo" style="color:black;font-weight:bold;display:none"></span><br>
                            <span id="pageDocRecProdsDataStateName" style="color:black;font-weight:bold;font-size:12px;display:none"></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="page-content" id="pageContentDocRecProdsData">
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th rowSpan="2" width="40px"><span class="table-header-small">№<br>п/п</span></th>
                <th width="50px"><span class="table-header-small">Код</span></th>
                <th colSpan="4"><span class="table-header-small">Наименование товара</span></th>
            </tr>
            <tr>
                <th width="100px"><span class="table-header-small">Штрихкод</span></th>
                <!--<th width="50px"><span class="table-header-small">Ед.<br>изм.</span></th>-->
                <th><span class="table-header-small">Статус товара</span></th>
                <th width="50px"><span class="table-header-small">Кол-во</span></th>
                <th width="70px"><span class="table-header-small">Сумма</span></th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true" onCreated="contentTableTROnCreated" onClick="contentTableTROnClick">
                <td rowSpan="2" width="40px" class="tdSrcPosID"><div class="table-text" dataItemName="SrcPosID"></div></td>
                <td width="50px" class="text-centered"><div class="table-text" dataItemName="ProdID"></div></td>
                <td colSpan="4" class="tdProdName"><div class="table-text" dataItemName="ProdName"></div></td>
            </tr>
            <tr rowSelecting="true" onCreated="contentTableTROnCreated" onClick="contentTableTROnClick">
                <td width="100px" class="text-centered"><div class="table-text" dataItemName="Barcode"></div></td>
                <!--<td width="50px" class="text-centered"><div class="table-text" dataItemName="UM"></div></td>-->
                <td class="text-centered"><div class="table-text" dataItemName="SecName"></div></td>
                <td width="50px" class="tdQty"><div class="table-text" dataItemName="Qty"></div></td>
                <td width="70px" class="tdSumCC"><div class="table-text" dataItemName="SumCC_wt"></div></td>
            </tr>
            </tbody>
        </table>
        <table class="mobile-table-small-size" width="100%" style="margin-top:33px;margin-bottom:30px;"></table>
        <table class="mobile-table-small-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px">0</td>
                <td></td>
                <td id="totalQty" width="50px">0</td>
                <td id="totalSumCC_wt" width="70px">0</td>
            </tr>
            </tfoot>
        </table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;top:88px;z-index:100">
            <thead>
            <tr>
                <th width="40px"><div class="table-header-large">№<br>п/п</div></th>
                <th width="110px"><div class="table-header-large">Штрихкод</div></th>
                <th width="50px"><div class="table-header-large">Код товара</div></th>
                <th><div class="table-header-large">Наименование товара</div></th>
                <th width="50px"><div class="table-header-large">Ед.<br>изм.</div></th>
                <th width="50px"><div class="table-header-large">Кол-во</div></th>
                <th width="70px"><div class="table-header-large">Сумма</div></th>
                <th width="150px"><div class="table-header-large">Статус товара</div></th>
            </tr>
            </thead>
            <tbody style="display:none">
            <tr rowSelecting="true" onCreated="contentTableTROnCreated" onClick="contentTableTROnClick">
                <td width="40px" class="tdSrcPosID"><div class="table-text" dataItemName="SrcPosID"></div></td>
                <td width="110px" style="min-width:110px" class="text-centered"><div class="table-text" dataItemName="Barcode"></div></td>
                <td width="50px" class="text-centered"><div class="table-text" dataItemName="ProdID"></div></td>
                <td class="tdProdName"><div class="table-text" dataItemName="ProdName"></div></td>
                <td width="50px" class="text-centered"><div class="table-text" dataItemName="UM"></div></td>
                <td width="50px" class="tdQty"><div class="table-text" dataItemName="Qty"></div></td>
                <td width="70px" class="tdSumCC"><div class="table-text" dataItemName="SumCC_wt"></div></td>
                <td width="150px" class="text-centered"><div class="table-text" dataItemName="SecName"></div></td>
            </tr>
            </tbody>
        </table>
        <table class="mobile-table-large-size" width="100%" style="margin-top:33px;margin-bottom:30px;"></table>
        <table class="mobile-table-large-size" width="100%" style="position:fixed;left:0px;bottom:0px;z-index:100">
            <tfoot>
            <tr>
                <td id="totalRows" width="40px"><span class="table-total">0</span></td>
                <td><span class="table-total"></span></td>
                <td id="totalQty" width="50px"><span class="table-total">0</span></td>
                <td id="totalSumCC_wt" width="70px"><span class="table-total">0</span></td>
                <td width="150px"><span class="table-total"></span></td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        on: {
            pageInit: function(e,page){
                this.pageContentDocRecProdsData= $$(this.el).children("#pageContentDocRecProdsData");
                var contentTables= this.pageContentDocRecProdsData.children("table");
                if(contentTables&&contentTables[0]) this.contentTableHeaderDomEl= contentTables[0];
                if(contentTables&&contentTables[1]) this.contentTableDataDomEl= contentTables[1];
                if(contentTables&&contentTables[2]) this.contentTableFootDomEl= contentTables[2];
                if(contentTables&&contentTables[3]) this.contentTableLHeaderDomEl= contentTables[3];
                if(contentTables&&contentTables[4]) this.contentTableLDataDomEl= contentTables[4];
                if(contentTables&&contentTables[5]) this.contentTableLFootDomEl= contentTables[5];
                this.pageDocRecProdsDataBtnNewPos= $$('#pageDocRecProdsDataToolbar #pageDocRecProdsDataBtnNewPos');
                this.pageDocRecProdsDataBtnEdtSel= $$('#pageDocRecProdsDataToolbar #pageDocRecProdsDataBtnEdtSel');
                this.pageDocRecProdsDataBtnDelSel= $$('#pageDocRecProdsDataToolbar #pageDocRecProdsDataBtnDelSel');
                this.pageDocRecProdsDataStateInfo= $$('#pageDocRecProdsDataToolbar #pageDocRecProdsDataStateInfo'),
                this.pageDocRecProdsDataStateName= $$('#pageDocRecProdsDataToolbar #pageDocRecProdsDataStateName')
                var pageDocRecProdsDataToolbar= $$('#pageDocRecProdsDataToolbar')[0];
                if(pageDocRecProdsDataToolbar&&pageDocRecProdsDataToolbar.offsetWidth>768){
                    this.pageDocRecProdsDataBtnNewPos.text("+ Добавить");
                    this.pageDocRecProdsDataBtnEdtSel.text("# Изменить");
                    this.pageDocRecProdsDataBtnDelSel.text("- Удалить");
                }
                if(this.isDocReadOnly()){ this.loadRecProdsData(); return; }
                var self=this;
                this.pageDocRecProdsDataBtnNewPos.on('click',function(){
                    app7.router.navigate("/pageDocRecBtkProdSrcData/"+self.docData["ChID"]+"/new/null",{})
                });
                this.pageDocRecProdsDataBtnEdtSel.on('click',function(){
                    var selTableRow= (self.selectedContentTableItemData)?self.selectedContentTableItemData["SrcPosID"]:null;
                    if(!selTableRow) return;
                    app7.router.navigate("/pageDocRecBtkProdSrcData/"+self.docData["ChID"]+"/edit/"+selTableRow,{})
                });
                this.pageDocRecProdsDataBtnDelSel.on('click',function(){
                    var selTableRow= (self.selectedContentTableItemData)?self.selectedContentTableItemData["SrcPosID"]:null;
                    if(!selTableRow) return;
                    app7.router.navigate("/pageDocRecBtkProdSrcData/"+self.docData["ChID"]+"/del/"+selTableRow,{})
                });
            },
            pageAfterIn: function(e,page){
                var recDProdSrcData= app7.data.pageRecDProdSrcData;
                if(recDProdSrcData){ this.selectedContentTableItemData= recDProdSrcData; app7.data.pageRecDProdSrcData= null; }
                var self=this;
                this.loadRecProdsData(function(){ self.findAndSelTableRow(); });
            },
            pageAfterOut: function(e,page){
                if(this.progressBarEl)this.$app.progressbar.hide(this.progressBarEl);
            },
        },
        data: function data(){
            if(!this.$route.params) return {};
            var listRecsData= app7.data.pageDocRecDocsList.listDocs, recChID= this.$route.params.recChID;
            if(!listRecsData||recChID===null||recChID===undefined) return {};
            var recData={};
            for(var ind in listRecsData){
                var itemRecData= listRecsData[ind];
                if(itemRecData&&itemRecData.ChID==recChID){ recData=itemRecData; break; }
            }
            return {docData:recData};
        },
        methods: {
            isDocReadOnly: function(){
                return !this.docData||!(this.docData["IsStateCreated"]||this.docData["IsStateReturned"]);
            },
            loadRecProdsData: function(callback){
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],
                        {totalRows:0,totalQty:0,totalSumCC_wt:0});
                var recData=this.docData, recChID=recData.ChID;
                if(recChID===null||recChID===undefined) return;
                var self=this;
                self.setToolbarByState();
                app7.preloader.show();
                app7.srvRequestJSON({url:'/mobile/docRecBtk/getDataForRecDTable',conditions:{'docChID=':recChID},
                            errorDialogMsg:"Не удалось получить список товаров прихода товара с сервера!"},
                        function(result,error){
                            app7.preloader.hide();
                            var resultItems= (result)?result.items:null;
                            self.contentTableData= resultItems;
                            if(!resultItems){ self.setToolbarByState(); return; }
                            app7.data.pageDocRecProdsData= {docProdsItems:resultItems};
                            var params={ contentTableHeaderDomEl:self.contentTableHeaderDomEl,contentTableDataDomEl:self.contentTableDataDomEl,
                                    contentTable2HeaderDomEl:self.contentTableLHeaderDomEl,contentTable2DataDomEl:self.contentTableLDataDomEl,
                                    progressAction:function(tableData, ind,tableDataItem){
                                        if(!tableDataItem){ self.setTotalInfo(0,0); return; }
                                        self.setTotalInfo(tableDataItem["Qty"],tableDataItem["SumCC_wt"],ind+1);
                                    }
                            };
                            app7.innerPageFillTableData(self, resultItems,params,function(contentTableData,contentTableDataDomTRs){
                                self.setToolbarByState();
                                if(callback) callback();
                            });
                        })
            },
            setTotalInfo: function(tQty,tSumCC_wt,tLoadedRows){
                var tRows= this.contentTableData.length.toString();
                if(tLoadedRows!==undefined) tRows= tLoadedRows.toString()+"/<br>"+tRows;
                var contentTableFootTR= $$(this.contentTableFootDomEl).find("tr"),
                        totalQty= parseFloat(contentTableFootTR.find("td#totalQty").text())+tQty,
                        totalSumCC_wt= parseFloat(contentTableFootTR.find("td#totalSumCC_wt").text())+tSumCC_wt;
                app7.innerPageUpdateTotalTable([this.contentTableFootDomEl,this.contentTableLFootDomEl],
                        {totalRows:tRows,totalQty:totalQty,totalSumCC_wt:totalSumCC_wt});
            },
            contentTableTROnCreated: function(tr,tableDataItem,newTRs,methods){
                tr.doSelect= methods["rowSelectingMethod"];
            },
            contentTableTROnClick: function(e,tr,contentTableDataItem,self){
                self.selectedContentTableItemData= contentTableDataItem;
            },
            setToolbarByState: function(){
                if(this.isDocReadOnly()||!this.contentTableData){
                    this.pageDocRecProdsDataBtnNewPos.hide(); this.pageDocRecProdsDataBtnEdtSel.hide(); this.pageDocRecProdsDataBtnDelSel.hide();
                    this.pageDocRecProdsDataStateInfo.show(); this.pageDocRecProdsDataStateInfo.text(this.docData["StateInfo"]);
                    this.pageDocRecProdsDataStateName.show(); this.pageDocRecProdsDataStateName.text("("+this.docData["StateName"]+")");
                    return
                }
                this.pageDocRecProdsDataBtnNewPos.show(); this.pageDocRecProdsDataBtnEdtSel.show(); this.pageDocRecProdsDataBtnDelSel.show();
                this.pageDocRecProdsDataStateInfo.hide(); this.pageDocRecProdsDataStateName.hide();
            },
            findAndSelTableRow: function(){
                var selProdData= this.selectedContentTableItemData;
                if(!selProdData) return;
                if(!this.contentTableData||this.contentTableData.length==0){ this.selectedContentTableItemData=null; return; };

                var findedSelDataItem=null;
                for(var ind=0;ind<this.contentTableData.length;ind++){
                    var ctDataItem= this.contentTableData[ind];
                    if(!ctDataItem) continue;
                    if(ctDataItem["SrcPosID"]==selProdData["SrcPosID"]){ findedSelDataItem= ctDataItem; break; }
                }
                if(!findedSelDataItem){
                    for(ind=0;ind<this.contentTableData.length;ind++){
                        var ctDataItem= this.contentTableData[ind];
                        if(!ctDataItem) continue;
                        if(ctDataItem["SrcPosID"]<selProdData["SrcPosID"]){ findedSelDataItem= ctDataItem; }
                    }
                }
                if(!findedSelDataItem){ this.selectedContentTableItemData=null; return; }
                this.selectedContentTableItemData= findedSelDataItem;
                var cdDataDomElTDs= $$(this.contentTableDataDomEl).children('tr').children('td').find('[dataItemName="SrcPosID"]');
                var ctDataDomElTDel= null, ctDataDomElTRsel=null;
                for(var i=0;i<cdDataDomElTDs.length;i++){
                    ctDataDomElTDel= cdDataDomElTDs[i];
                    if(ctDataDomElTDel.innerText==findedSelDataItem["SrcPosID"]){ ctDataDomElTRsel= ctDataDomElTDel.parentNode.parentNode; break; }
                }
                if(ctDataDomElTRsel) ctDataDomElTRsel.doSelect();
                if(ctDataDomElTRsel&&ctDataDomElTRsel.clientHeight!=0&&ctDataDomElTRsel.clientWidth!=0)  this.setScroll(ctDataDomElTRsel);
                cdDataDomElTDs= $$(this.contentTableLDataDomEl).children('tr').children('td').find('[dataItemName="SrcPosID"]');
                ctDataDomElTDel= null; ctDataDomElTRsel=null;
                for(var i=0;i<cdDataDomElTDs.length;i++){
                    ctDataDomElTDel= cdDataDomElTDs[i];
                    if(ctDataDomElTDel.innerText==findedSelDataItem["SrcPosID"]){ ctDataDomElTRsel= ctDataDomElTDel.parentNode.parentNode; break; }
                }
                if(ctDataDomElTRsel) ctDataDomElTRsel.doSelect();
                if(ctDataDomElTRsel&&ctDataDomElTRsel.clientHeight!=0&&ctDataDomElTRsel.clientWidth!=0)  this.setScroll(ctDataDomElTRsel);
            },
            setScroll: function(innerElem){
                var page= this.pageContentDocRecProdsData[0],
                        absoluteElementTop= innerElem.getBoundingClientRect().top + page.scrollTop;
                page.scrollTop= absoluteElementTop - (page.clientHeight / 2);
            }
        }
    }
</script>
