<TDocStdTable id="docs_excCashier_PageContainer" style="width:100%;height:100%;">
    <div id="docs_excCashier_ListContainer" style="width:800px;height:100%; margin:0;padding:0;"></div>
    <div id="docs_excCashier_DetailContainer" style="width:100%;height:100%; margin:0;padding:0;">
        <div id="docs_excCashier_DetailHeader" style="width:100%;height:auto; margin:0;padding:0;"></div>
        <div id="docs_excCashier_ProductsTable" style="width:100%;height:100%; margin:0;padding:0;"></div>
        <div id="docs_excCashier_DetailTotal" style="width:100%;height:auto;; margin:0;padding:0;"></div>
    </div>
    <div id="docs_excCashier_DetailPanesContainer" style="width:250px;height:100%; margin:0;padding:0;"></div>
</TDocStdTable>
<script type="text/javascript">
    $$.docs_excCashier_PageContainer
            .init({idListContainer:"docs_excCashier_ListContainer",idDetailContainer:"docs_excCashier_DetailContainer",
                idDetailHeader:"docs_excCashier_DetailHeader",idDetailTable:"docs_excCashier_ProductsTable",idDetailTotal:"docs_excCashier_DetailTotal",
                idDetailPanesContainer:"docs_excCashier_DetailPanesContainer",
                buttonPrint:{printParams:{minTableWidth:1100}}, buttonExportToExcel:false})
            .addListTable({getDataUrl:"/docs/excCashier/getDataForExcsListTable",
                header:"Список накладных", bdatelabelText:"c",bdateCondition:"DOCDATE>=", edatelabelText:"по",edateCondition:"DOCDATE<="
            })
            .setDetailHeaderParameters({dataIDName:"ChID",getDataUrl:"/docs/excCashier/getExcData",
                detailHeaderEditable:false,
                detailTableEditable:function(params){
                    if(!params||!params.detailHeaderContentData) return false;
                    var stateCode=params.detailHeaderContentData["StateCode"];
                    return stateCode==50||stateCode==56||stateCode==60;
                }
            })
            .addDetailHeaderTitle({title:"Перемещение товара на ТТ",titleForNothing:"Перемещение товара не выбрано", titleForFailedLoad:"Нет данных",
                numberDataItemName:"DocID", dateDataItemName:"DocDate", titleDatePrefix:"от"},25)
            .addDetailHeaderRow(25,true)
            .addDetailHeaderTextBox("OurName","Фирма", 310,{inputStyle:"width:250px"})
            .addDetailHeaderTextBox("DocID", "Номер", 120,{inputStyle:"width:70px"})
            .addDetailHeaderTextBox("IntDocID", "Вн. номер", 140,{inputStyle:"width:70px"})
            .addDetailHeaderDateTextBox("DocDate", "Дата", 120,{inputStyle:"width:80px",noPrevNextButtons:true})
            .addDetailHeaderTextBox("CurrName","Валюта", 110,{inputStyle:"width:50px"})
            .addDetailHeaderRow(25,true)
            .addDetailHeaderTextBox("StockName","Со склада", 320,{inputStyle:"width:250px"})
            .addDetailHeaderTextBox("NewStockName","На склад", 320,{inputStyle:"width:250px"})
            .setDetailTableParameters({conditionIDName:"ParentChID",
                getDataUrl:"/docs/excCashier/getDataForExcDTable",
                storeDataUrl:"/docs/excCashier/storeExcDTableData", deleteDataUrl:"/docs/excCashier/deleteExcDTableData"})
            .addDetailTotalRow()
            .addDetailSubTotalCountNumberTextBox("ИТОГО СТРОК:", 140,{inputStyle:"width:40px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО КОЛ-ВО:", 230,"Qty",{pattern:"###,###,##0.#########",inputStyle:"width:50px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО ФАКТ. КОЛ-ВО:", 240,"NewQty",{pattern:"###,###,##0.#########",inputStyle:"width:50px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО СУММА:", 220,"SumCC",{pattern:"###,###,##0.00#######",inputStyle:"width:80px;"})
            .addDetailSubtotalNumberTextBox("ИТОГО ФАКТ. СУММА:", 250,"NewSumCC",{pattern:"###,###,##0.00#######",inputStyle:"width:80px;"})
            .addDetailTotalRow(true)
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ КОЛ-ВО:", 372,"TQty",
                {pattern:"###,###,##0.#########", style:"font-weight:bold;",inputStyle:"width:50px;", printLabel:"ИТОГО КОЛИЧЕСТВО:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ ФАКТ. КОЛ-ВО:", 240,"TNewQty",
                {pattern:"###,###,##0.#########", style:"font-weight:bold;",inputStyle:"width:50px;", printLabel:"ИТОГО ФАКТ. КОЛИЧЕСТВО:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ СУММА:", 220,"TSumCC",
                {pattern:"###,###,##0.00#######", style:"font-weight:bold;",inputStyle:"width:80px;", printLabel:"ИТОГО СУММА:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ ФАКТ. СУММА:", 250,"TNewSumCC",
                {pattern:"###,###,##0.00#######", style:"font-weight:bold;",inputStyle:"width:80px;", printLabel:"ИТОГО ФАКТ. СУММА:"})
            .addDetailTotalRow(true)
            .addDetailTotalTextBox("Статус:", 260,"StateName",{style:"font-weight:bold;",inputStyle:"width:200px"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ ОТКЛОНЕНИЕ ПО КОЛ-ВУ:", 352,"TDiffQty",
                {pattern:"###,###,##0.#########", style:"font-weight:bold;",inputStyle:"width:50px;", printLabel:"ИТОГО ОТКЛОНЕНИЕ ПО КОЛ-ВУ:"})
            .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ ОТКЛОНЕНИЕ ПО СУММЕ:", 471,"TDiffSumCC",
                {pattern:"###,###,##0.00#######", style:"font-weight:bold;",inputStyle:"width:80px;", printLabel:"ИТОГО ОТКЛОНЕНИЕ ПО СУММЕ:"})
            .addToolPane({title:"Действия"})
            .addToolPaneActionButton("Изменить строку", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableSelectedRow"})
            .addToolPaneActionButton("Изменить все строки", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableAllVisibleRows"})
            .addToolPaneBR()
            .addToolPaneActionButton("Заполнить факт", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var dhtContentEditableRows= ap.detailHTable.getContentEditableRows();
                    ap.detailHTable.updateRowsAction(dhtContentEditableRows,{},
                            /*actionFunction*/function(rowData, actionParams, updatedRowData, nextAction, finishedAction){
                                updatedRowData["NewQty"]= rowData["Qty"];
                                nextAction();
                            }
                    );
                },
                actionStateFunction:function(ap){
                    if(ap.detailHeader.getContentData() && !ap.detailHeader.isContentChanged() && ap.detailHTable.getContentEditableRows().length>0)
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPaneBR()
            .addToolPaneActionButton("Сохранить строку", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableSelectedRow"})
            .addToolPaneActionButton("Сохранить все строки", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableAllEditableRows"})
            .addDetailTableMenuItemAction("Изменить строки",{action:"allowEditDetailTableSelectedRows"})
            .addDetailTableMenuItemAction("Сохранить строки",{action:"storeDetailTableSelectedRows"})
            .addToolPane({title:"Статус"})
            .addToolPaneActionButton("В статус \"Подтвержден\"", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(!detailHeaderContentData){ this.setDisabled(true); return; }
                    var docStateData= {"StateCode":detailHeaderContentData["StateCode"],"StateName":detailHeaderContentData["StateName"]},
                            stateCodeCashierConfirm= detailHeaderContentData["StateCodeCashierConfirm"],
                            detailHeaderContentChangedData= {"StateCode":stateCodeCashierConfirm};
                    $$.request.getJSONData({url:"/dirsDocs/getDirStateData", resultItemName:"item",
                                conditions:{"StateCode":detailHeaderContentChangedData["StateCode"]+""},
                                errorDialogMsg:"Не удалось получить данные для перевода документа в статус "+stateCodeCashierConfirm+"!"},
                            function(result,error){
                                if(!result||error)return;
                                var newStateName= result["StateName"];
                                detailHeaderContentChangedData["StateName"]= newStateName;
                                ap.detailHeader.setContentDataItems(detailHeaderContentChangedData,{onlyValues:true,callContentUpdated:true});
                                $$.request.postJSONData({url:"/docs/excCashier/updExcDataState", resultItemName:"resultItem",
                                            data:{"ChID":detailHeaderContentData["ChID"],"StateCode":detailHeaderContentChangedData["StateCode"]},
                                            errorDialogMsg:"Не удалось перевести документ в статус \""+newStateName+"\" ("+stateCodeCashierConfirm+")!"},
                                        function(result,error){
                                            if(!result||error){
                                                ap.detailHeader.setContentDataItems(docStateData,{onlyValues:false,callContentUpdated:true});
                                                return;
                                            }
                                            ap.detailHeader.setContentDataItems({"StateCode":result["StateCode"],"StateName":result["StateName"]},
                                                    {onlyValues:false,callContentUpdated:true,updatedResultItem:detailHeaderContentChangedData});
                                        });
                            });
                },
                actionStateFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(detailHeaderContentData && !ap.detailHeader.isContentChanged()
                            && ap.thisDoc.detailTableEditableChecker() && ap.detailHTable.getContent().length>0)
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPaneActionButton("В статус \"Возвращен\"", {btnStyle:"width:200px;",
                actionFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(!detailHeaderContentData){ this.setDisabled(true); return; }
                    var docStateData= {"StateCode":detailHeaderContentData["StateCode"],"StateName":detailHeaderContentData["StateName"]},
                            stateCodeCashierRetrieve= detailHeaderContentData["StateCodeCashierRetrieve"],
                            detailHeaderContentChangedData= {"StateCode":stateCodeCashierRetrieve};
                    $$.request.getJSONData({url:"/dirsDocs/getDirStateData", resultItemName:"item",
                                conditions:{"StateCode":detailHeaderContentChangedData["StateCode"]+""},
                                errorDialogMsg:"Не удалось получить данные для перевода документа в статус "+stateCodeCashierRetrieve+"!"},
                            function(result,error){
                                if(!result||error)return;
                                var newStateName= result["StateName"];
                                detailHeaderContentChangedData["StateName"]= newStateName;
                                ap.detailHeader.setContentDataItems(detailHeaderContentChangedData,{onlyValues:true,callContentUpdated:true});
                                $$.request.postJSONData({url:"/docs/excCashier/updExcDataState", resultItemName:"resultItem",
                                            data:{"ChID":detailHeaderContentData["ChID"],"StateCode":detailHeaderContentChangedData["StateCode"]},
                                            errorDialogMsg:"Не удалось перевести документ в статус \""+newStateName+"\" ("+stateCodeCashierRetrieve+")!"},
                                        function(result,error){
                                            if(!result||error){
                                                ap.detailHeader.setContentDataItems(docStateData,{onlyValues:false,callContentUpdated:true});
                                                return;
                                            }
                                            ap.detailHeader.setContentDataItems({"StateCode":result["StateCode"],"StateName":result["StateName"]},
                                                    {onlyValues:false,callContentUpdated:true,updatedResultItem:detailHeaderContentChangedData});
                                        });
                            });
                },
                actionStateFunction:function(ap){
                    var detailHeaderContentData= ap.detailHeader.getContentData();
                    if(detailHeaderContentData && !ap.detailHeader.isContentChanged()
                            && ap.thisDoc.detailTableEditableChecker())
                        this.setDisabled(false);
                    else
                        this.setDisabled(true);
                }
            })
            .addToolPane({title:"Печать"})
            .addDetailHeaderBtnPrintItem({name:"Акт расхождений",onClick:function(menuItemData,ap){
                var printWindow= window.open("/print/printDocFromTemplate");
                printWindow["docTemplateName"]= "excDiffReport"; printWindow["docContentData"]= ap.thisDoc.getDataForPrint();
            }})
            .addToolPaneActionButton("Печать Акта расхождений", {btnStyle: "width:200px;",
                actionFunction: function(ap){
                    ap.thisDoc.runDetailHeaderBtnPrintItemAction({name:"Акт расхождений"});
                }
            })
            .addToolPane({title:"Информация о товаре",
                detailTableAction:function(params){
                    var detailTableSelectedRow= params.detailHTable.getSelectedRow();
                    if(!detailTableSelectedRow){ params.toolPaneContent.set("content",""); return; }
                    var htCols = params.detailHTable.getColumns(), prodInfoHtml = "";
                    for(var c=0;c<htCols.length;c++){
                        var colItem = htCols[c]; var colData = colItem["data"], colValue = detailTableSelectedRow[colData];
                        if(colData.indexOf('Prod')==0||colData=='UM'||colData.indexOf('Barcode')==0
                                ||colData.indexOf('Article')==0||colData.indexOf('PCat')==0||colData.indexOf('PGr')==0
                                ||colData.indexOf('Color')==0||colData.indexOf('Size')==0)
                            prodInfoHtml = prodInfoHtml + "<tr><td>"+"<b>"+colItem["name"]+":</b> "+((!colValue)?'':colValue)+"</td></tr>";
                    }
                    params.toolPaneContent.set("content","<table style=\"margin:0;padding:0;\">"+prodInfoHtml+"</table>");
                }
            })
            .addToolInnerPage("Ценник товара", function(params){
                var detailTableSelectedRow= params.detailHTable.getSelectedRow();
                if(!detailTableSelectedRow){ params.toolPaneContent.set("content",""); return; }
                var prodTagContentData = {};
                for(var rowItemName in detailTableSelectedRow) prodTagContentData[rowItemName]= detailTableSelectedRow[rowItemName];
                params.toolPaneContent.set("prodTagContentData", prodTagContentData);
                if(!params.toolPaneContent.get("href")&&!params.toolPaneContent.get("content")){
                    params.toolPaneContent.set("href","/print/productTag40x25");
//                    params.toolPaneContent.set("href","/print/productTag58x30");
                }else{
                    params.toolPaneContent.set("content",params.toolPaneContent.get("content"));
                }
            })
            .startupDoc();
</script>
